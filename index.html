<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledger Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Your existing CSS styles */
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dr-color: #dc2626;
            --cr-color: #059669;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .live-balance {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation */
        .main-nav {
            width: 280px;
            background: var(--bg-white);
            padding: 1.5rem 1rem;
            margin-top: 76px;
            height: calc(100vh - 76px);
            position: fixed;
            left: 0;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section h3 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .nav-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .nav-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .nav-btn:active {
            transform: translateX(4px) scale(0.98);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            margin-top: 76px;
            padding: 2rem;
            min-height: calc(100vh - 76px);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Forms */
        .form-container {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--bg-white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        /* Tables */
        .table-container {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 2rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr:hover {
            background: var(--bg-light);
        }

        /* Balance indicators */
        .dr-badge {
            background: #fee2e2;
            color: var(--dr-color);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .cr-badge {
            background: #d1fae5;
            color: var(--cr-color);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Amount Calculation */
        .amount-calculation {
            background: #f0f9ff;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            border-left: 4px solid var(--primary);
        }

        .calculation-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .calculation-total {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary);
            border-top: 2px solid var(--border);
            padding-top: 0.5rem;
            margin-top: 0.5rem;
        }

        /* Import Preview */
        .import-preview {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .preview-table {
            width: 100%;
            font-size: 0.875rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            border: 1px solid var(--border);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: var(--bg-white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: var(--bg-light);
        }

        .file-upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
            }

            .main-nav {
                transform: translateX(-100%);
                width: 280px;
                z-index: 999;
            }

            .main-nav.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .header-content h1 {
                font-size: 1.2rem;
            }

            .live-balance {
                font-size: 0.875rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .data-table {
                font-size: 0.75rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }

            .modal {
                max-width: 95%;
                padding: 1.5rem;
            }

            .notification {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .form-control {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* Print Styles */
        @media print {
            .app-header,
            .main-nav,
            .btn,
            .mobile-toggle {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .data-table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-toggle" id="mobileToggle">‚ò∞</button>
                    <h1>üìä Ledger Management System</h1>
                </div>
                <div class="header-actions">
                    <div class="sync-status" id="syncStatus">
                        <div class="sync-indicator"></div>
                        <span>Synced</span>
                    </div>
                    <span class="live-balance" id="liveBalance">Balance: Rs. 0</span>
                </div>
            </div>
        </header>

        <nav class="main-nav" id="mainNav">
            <div class="nav-section">
                <h3>üìä Operations</h3>
                <button class="nav-btn" onclick="showSection('dashboard')">üè† Dashboard</button>
                <button class="nav-btn" onclick="showSection('entry')">‚úì Submit Entry</button>
                <button class="nav-btn" onclick="showSection('customers')">üë• Customers</button>
            </div>

            <div class="nav-section">
                <h3>üíæ Data Management</h3>
                <button class="nav-btn" onclick="showSection('import')">üì• Import Data</button>
                <button class="nav-btn" onclick="showSection('google-sheets')">üîó Google Sheets Sync</button>
                <button class="nav-btn" onclick="exportAllData()">üì§ Export All</button>
                <button class="nav-btn" onclick="viewBalanceSheet()">üìä Balance Sheet</button>
            </div>

            <div class="nav-section">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="nav-btn" onclick="clearAllData()">üóëÔ∏è Clear Data</button>
                <button class="nav-btn" onclick="showHelp()">‚ùì Help</button>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 1.5rem;">Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>Total Customers</h3>
                        <div class="stat-number" id="totalCustomers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Transactions</h3>
                        <div class="stat-number" id="totalTransactions">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total DR Balance</h3>
                        <div class="stat-number" id="totalDR">Rs. 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total CR Balance</h3>
                        <div class="stat-number" id="totalCR">Rs. 0</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="padding: 1rem; background: var(--bg-light);">Recent Transactions</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>S.N</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Description</th>
                                    <th>Item</th>
                                    <th>Weight/Qty</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>DR/CR</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactions">
                                <tr><td colspan="9" style="text-align: center; padding: 2rem;">No transactions yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Data Entry -->
            <div id="entry" class="section">
                <h2 style="margin-bottom: 1.5rem;">Submit Entry</h2>
                <div class="form-container">
                    <form id="entryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-control" name="date" id="dateInput" required>
                            </div>
                            <div class="form-group">
                                <label>Customer *</label>
                                <select class="form-control" name="customer" id="customerSelect" required>
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description *</label>
                            <input type="text" class="form-control" name="description" placeholder="Transaction description" required>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Item</label>
                                <select class="form-control" name="item" id="itemSelect">
                                    <option value="">Select Item</option>
                                    <option>Chilled Gots</option>
                                    <option>Chilled Scrape</option>
                                    <option>Guides</option>
                                    <option>Chilled Rolls</option>
                                    <option>Fire Bricks</option>
                                    <option>H Oil</option>
                                    <option>Magnese</option>
                                    <option>Chrome</option>
                                    <option>Black Scrape</option>
                                    <option>White Scrape</option>
                                    <option>Toka Scrape</option>
                                    <option>Pig Scrape</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Weight/Qty</label>
                                <input type="number" class="form-control" name="weightQty" step="0.01" placeholder="0.00" id="weightQtyInput">
                            </div>
                            <div class="form-group">
                                <label>Rate (PKR)</label>
                                <input type="number" class="form-control" name="rate" step="0.01" placeholder="0.00" id="rateInput">
                            </div>
                        </div>

                        <!-- Amount Calculation Display -->
                        <div class="amount-calculation" id="amountCalculation" style="display: none;">
                            <h4>Amount Calculation</h4>
                            <div class="calculation-row">
                                <span>Weight/Qty:</span>
                                <span id="calcWeight">0.00</span>
                            </div>
                            <div class="calculation-row">
                                <span>Rate:</span>
                                <span id="calcRate">Rs. 0.00</span>
                            </div>
                            <div class="calculation-row">
                                <span>Calculation Type:</span>
                                <span id="calcType">Standard</span>
                            </div>
                            <div class="calculation-row calculation-total">
                                <span>Total Amount:</span>
                                <span id="calcTotal">Rs. 0.00</span>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Transaction Type *</label>
                                <select class="form-control" name="transactionType" required>
                                    <option>Sale</option>
                                    <option>Payment Received - Cash</option>
                                    <option>Payment Received - Bank</option>
                                    <option>Payment Given - Cash</option>
                                    <option>Payment Given - Bank</option>
                                    <option>Purchase</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select class="form-control" name="paymentMethod">
                                    <option>Cash</option>
                                    <option>Cheque</option>
                                    <option>Bank Transfer</option>
                                    <option>Jazzcash</option>
                                    <option>Easypaisa</option>
                                    <option>Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Bank Name</label>
                                <select class="form-control" name="bankName">
                                    <option value="">Select Bank</option>
                                    <option>HBL</option>
                                    <option>UBL</option>
                                    <option>MCB</option>
                                    <option>Allied Bank</option>
                                    <option>Bank Alfalah</option>
                                    <option>Meezan Bank</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cheque No.</label>
                                <input type="text" class="form-control" name="chequeNo" placeholder="Cheque number">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Debit (PKR)</label>
                                <input type="number" class="form-control" name="debit" step="0.01" placeholder="0.00" id="debitInput">
                            </div>
                            <div class="form-group">
                                <label>Credit (PKR)</label>
                                <input type="number" class="form-control" name="credit" step="0.01" placeholder="0.00" id="creditInput">
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">‚úì Submit Entry</button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers" class="section">
                <h2 style="margin-bottom: 1.5rem;">Customer Management</h2>
                <div class="form-container" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Add New Customer</h3>
                    <form id="customerForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" class="form-control" name="customerName" required>
                            </div>
                            <div class="form-group">
                                <label>Opening Balance</label>
                                <input type="number" class="form-control" name="openingBalance" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Balance Type</label>
                                <select class="form-control" name="balanceType">
                                    <option value="DR">DR (Customer Owes)</option>
                                    <option value="CR">CR (We Owe)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">‚ûï Add Customer</button>
                    </form>
                </div>

                <div class="table-container">
                    <h3 style="padding: 1rem; background: var(--bg-light);">All Customers</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Balance</th>
                                    <th>DR/CR</th>
                                    <th>Transactions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerList">
                                <tr><td colspan="5" style="text-align: center; padding: 2rem;">No customers yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Import -->
            <div id="import" class="section">
                <h2 style="margin-bottom: 1.5rem;">Import Data</h2>
                <div class="form-container">
                    <div class="file-upload-area" id="dropZone">
                        <h3>üìÅ Drop Excel/CSV file here or click to browse</h3>
                        <p style="color: var(--text-light); margin-top: 0.5rem;">Supports .xlsx, .xls, .csv files</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="margin-top: 1rem;">Choose File</button>
                    </div>

                    <div id="importPreview" style="display: none;"></div>
                </div>
            </div>

            <!-- Google Sheets Sync -->
            <div id="google-sheets" class="section">
                <h2 style="margin-bottom: 1.5rem;">üîó Google Sheets Integration</h2>
                
                <div class="form-container" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Connect to Google Sheets</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Import ALL customer ledger sheets with complete transaction history
                    </p>

                    <form id="googleSheetsForm">
                        <div class="form-group">
                            <label>Published Google Sheets URL *</label>
                            <input type="text" class="form-control" name="sheetUrl" id="sheetUrl" 
                                   placeholder="https://docs.google.com/spreadsheets/d/..." required>
                            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                Paste the URL from "Publish to web" not the edit URL
                            </small>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="autoSync" id="autoSync" style="margin-right: 0.5rem;">
                                Enable Auto-Sync (Check for updates every 5 minutes)
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="mergeData" id="mergeData" style="margin-right: 0.5rem;" checked>
                                Merge with existing data (uncheck to replace all data)
                            </label>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üîó Connect & Import All Data</button>
                            <button type="button" class="btn btn-secondary" onclick="testGoogleSheetConnection()">
                                üß™ Test Connection
                            </button>
                        </div>
                    </form>
                </div>

                <div class="form-container" id="syncStatusContainer" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Sync Status</h3>
                    <div id="syncDetails" style="padding: 1rem; background: var(--bg-light); border-radius: 8px;">
                        <!-- Sync details will appear here -->
                    </div>
                    <div id="sheetsDiscovered" style="margin-top: 1rem;">
                        <!-- Sheets list will appear here -->
                    </div>
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="manualSync()">üîÑ Manual Sync Now</button>
                        <button class="btn btn-primary" onclick="viewSyncLog()">üìã View Sync Log</button>
                        <button class="btn btn-danger" onclick="disconnectGoogleSheets()">Disconnect</button>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>

    <script>
        // Ledger Application with FIXED Event Listeners and Scrap Calculation
        class LedgerApp {
            constructor() {
                this.data = {
                    customers: [],
                    transactions: [],
                    lastSync: null,
                    googleSheetConfig: null
                };
                this.syncInterval = null;
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.updateDashboard();
                this.startAutoSync();
                this.setDefaultDate();
            }

            setDefaultDate() {
                const dateInput = document.getElementById('dateInput');
                if (dateInput) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${year}-${month}-${day}`;
                }
            }

            async loadData() {
                try {
                    const saved = localStorage.getItem('ledger-data');
                    if (saved) {
                        this.data = JSON.parse(saved);
                        console.log('Data loaded successfully');
                    }
                } catch (error) {
                    console.log('No existing data found, starting fresh');
                }
            }

            async saveData() {
                try {
                    this.data.lastSync = new Date().toISOString();
                    localStorage.setItem('ledger-data', JSON.stringify(this.data));
                    this.updateSyncStatus('Synced');
                    return true;
                } catch (error) {
                    console.error('Save error:', error);
                    this.updateSyncStatus('Offline');
                    return false;
                }
            }

            setupEventListeners() {
                // Mobile navigation
                document.getElementById('mobileToggle').addEventListener('click', () => {
                    document.getElementById('mainNav').classList.toggle('active');
                });

                // Entry form
                const entryForm = document.getElementById('entryForm');
                if (entryForm) {
                    entryForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleEntrySubmit(e.target);
                    });
                }

                // Customer form
                const customerForm = document.getElementById('customerForm');
                if (customerForm) {
                    customerForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleCustomerSubmit(e.target);
                    });
                }

                // Google Sheets form
                const googleSheetsForm = document.getElementById('googleSheetsForm');
                if (googleSheetsForm) {
                    googleSheetsForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleGoogleSheetsSubmit(e.target);
                    });
                }

                // Amount calculation listeners
                const weightInput = document.getElementById('weightQtyInput');
                const rateInput = document.getElementById('rateInput');
                const itemSelect = document.getElementById('itemSelect');
                
                if (weightInput) weightInput.addEventListener('input', () => this.calculateAmount());
                if (rateInput) rateInput.addEventListener('input', () => this.calculateAmount());
                if (itemSelect) itemSelect.addEventListener('change', () => this.calculateAmount());

                // File import
                const fileInput = document.getElementById('fileInput');
                const dropZone = document.getElementById('dropZone');

                if (fileInput) {
                    fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                }
                
                if (dropZone) {
                    dropZone.addEventListener('click', () => fileInput.click());
                    dropZone.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        dropZone.classList.add('drag-over');
                    });
                    dropZone.addEventListener('dragleave', () => {
                        dropZone.classList.remove('drag-over');
                    });
                    dropZone.addEventListener('drop', (e) => {
                        e.preventDefault();
                        dropZone.classList.remove('drag-over');
                        this.handleFileSelect({ target: { files: e.dataTransfer.files } });
                    });
                }

                // Debit/Credit mutual exclusion
                const debitInput = document.getElementById('debitInput');
                const creditInput = document.getElementById('creditInput');
                if (debitInput && creditInput) {
                    debitInput.addEventListener('input', (e) => {
                        if (e.target.value) {
                            creditInput.value = '';
                        }
                    });
                    creditInput.addEventListener('input', (e) => {
                        if (e.target.value) {
                            debitInput.value = '';
                        }
                    });
                }

                // Load saved Google Sheets config
                this.loadGoogleSheetsConfig();
            }

            calculateAmount() {
                const weightQty = parseFloat(document.getElementById('weightQtyInput').value) || 0;
                const rate = parseFloat(document.getElementById('rateInput').value) || 0;
                const item = document.getElementById('itemSelect').value;
                
                let amount = 0;
                let calculationType = 'Standard';

                // Apply scrap calculation formula
                if (weightQty > 0 && rate > 0) {
                    if (item === "Black Scrape" || item === "White Scrape" || item === "Toka Scrape" || item === "Pig Scrape") {
                        // Scrap calculation: (weight/37.324) * rate
                        amount = (weightQty / 37.324) * rate;
                        calculationType = 'Scrap (Weight/37.324 √ó Rate)';
                    } else {
                        // Standard calculation: weight * rate
                        amount = weightQty * rate;
                        calculationType = 'Standard (Weight √ó Rate)';
                    }

                    document.getElementById('amountCalculation').style.display = 'block';
                    document.getElementById('calcWeight').textContent = weightQty.toFixed(2);
                    document.getElementById('calcRate').textContent = `Rs. ${rate.toFixed(2)}`;
                    document.getElementById('calcType').textContent = calculationType;
                    document.getElementById('calcTotal').textContent = `Rs. ${amount.toFixed(2)}`;
                    
                    // Auto-fill debit amount if not already set
                    const debitInput = document.getElementById('debitInput');
                    if (!debitInput.value) {
                        debitInput.value = amount.toFixed(2);
                    }
                } else {
                    this.hideAmountCalculation();
                }
            }

            hideAmountCalculation() {
                document.getElementById('amountCalculation').style.display = 'none';
                document.getElementById('calcWeight').textContent = '0.00';
                document.getElementById('calcRate').textContent = 'Rs. 0.00';
                document.getElementById('calcType').textContent = 'Standard';
                document.getElementById('calcTotal').textContent = 'Rs. 0.00';
            }

            async handleEntrySubmit(form) {
                const formData = new FormData(form);
                const debit = parseFloat(formData.get('debit')) || 0;
                const credit = parseFloat(formData.get('credit')) || 0;
                const weightQty = parseFloat(formData.get('weightQty')) || 0;
                const rate = parseFloat(formData.get('rate')) || 0;
                const item = formData.get('item');
                
                // Calculate amount based on item type
                let amount = 0;
                if (item === "Black Scrape" || item === "White Scrape" || item === "Toka Scrape" || item === "Pig Scrape") {
                    amount = (weightQty / 37.324) * rate;
                } else {
                    amount = weightQty * rate;
                }

                if (debit === 0 && credit === 0) {
                    this.showNotification('Please enter either Debit or Credit amount', 'error');
                    return;
                }

                const transaction = {
                    sn: this.data.transactions.length + 1,
                    date: formData.get('date'),
                    customer: formData.get('customer'),
                    description: formData.get('description'),
                    item: item,
                    weightQty: weightQty,
                    rate: rate,
                    amount: amount,
                    transactionType: formData.get('transactionType'),
                    paymentMethod: formData.get('paymentMethod'),
                    bankName: formData.get('bankName'),
                    chequeNo: formData.get('chequeNo'),
                    debit: debit,
                    credit: credit,
                    drCr: debit > 0 ? 'DR' : 'CR',
                    timestamp: new Date().toISOString()
                };

                this.data.transactions.push(transaction);
                
                // Update customer balance
                const customer = this.data.customers.find(c => c.name === transaction.customer);
                if (customer) {
                    customer.balance += debit - credit;
                    customer.transactionCount = this.data.transactions.filter(t => t.customer === customer.name).length;
                }

                await this.saveData();
                this.updateDashboard();
                form.reset();
                this.setDefaultDate();
                this.hideAmountCalculation();
                this.showNotification('Transaction added successfully!', 'success');
            }

            async handleCustomerSubmit(form) {
                const formData = new FormData(form);
                const openingBalance = parseFloat(formData.get('openingBalance')) || 0;
                const balanceType = formData.get('balanceType');
                
                const customer = {
                    name: formData.get('customerName'),
                    balance: balanceType === 'DR' ? openingBalance : -openingBalance,
                    transactionCount: 0,
                    created: new Date().toISOString()
                };

                // Check for duplicates
                if (this.data.customers.some(c => c.name.toLowerCase() === customer.name.toLowerCase())) {
                    this.showNotification('Customer already exists!', 'error');
                    return;
                }

                this.data.customers.push(customer);
                await this.saveData();
                this.updateCustomerList();
                this.updateCustomerSelect();
                form.reset();
                this.showNotification('Customer added successfully!', 'success');
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        this.showImportPreview(jsonData);
                    } catch (error) {
                        this.showNotification('Error reading file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            showImportPreview(data) {
                const preview = document.getElementById('importPreview');
                const sampleData = data.slice(0, 5);

                let html = `
                    <div class="import-preview">
                        <h3>Import Preview (${data.length} records found)</h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;">First 5 rows:</p>
                        <div class="table-responsive">
                            <table class="preview-table">
                                <thead><tr>`;

                if (sampleData.length > 0) {
                    Object.keys(sampleData[0]).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                    html += `</tr></thead><tbody>`;

                    sampleData.forEach(row => {
                        html += '<tr>';
                        Object.values(row).forEach(val => {
                            html += `<td>${val || ''}</td>`;
                        });
                        html += '</tr>';
                    });
                }

                html += `</tbody></table></div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="app.confirmImport(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                            ‚úì Confirm Import
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importPreview').style.display='none'">
                            Cancel
                        </button>
                    </div>
                </div>`;

                preview.innerHTML = html;
                preview.style.display = 'block';
            }

            async confirmImport(data) {
                try {
                    let importedCount = 0;

                    data.forEach(row => {
                        // Map column names (case-insensitive)
                        const getCol = (names) => {
                            for (let name of names) {
                                const key = Object.keys(row).find(k => 
                                    k.toLowerCase().trim() === name.toLowerCase()
                                );
                                if (key && row[key]) return row[key];
                            }
                            return '';
                        };

                        const sn = getCol(['SN', 'S.N', 'S.N.', 'Serial', 'No', 'Sr', 'Sr.', '#']);
                        const date = getCol(['Date', 'Transaction Date', 'Dated']);
                        const customerName = getCol(['Customer', 'Name', 'Party Name', 'Account']);
                        const description = getCol(['Description', 'Particulars', 'Details', 'Narration']);
                        const item = getCol(['Item', 'Product', 'Goods']);
                        const weightQty = parseFloat(getCol(['Weight/Qty', 'Quantity', 'Weight', 'Qty', 'Weight Qty'])) || 0;
                        const rate = parseFloat(getCol(['Rate', 'Rate (PKR)', 'Rate(PKR)', 'Price', 'Unit Price', 'Rate PKR'])) || 0;
                        const transactionType = getCol(['Transaction Type', 'Type', 'Trans Type', 'Transaction']);
                        const paymentMethod = getCol(['Payment Method', 'Method', 'Mode', 'Payment']);
                        const bankName = getCol(['Bank Name', 'Bank', 'Bank Account']);
                        const chequeNo = getCol(['Cheque No', 'Cheque No.', 'Check No', 'Cheque Number', 'Cheque']);
                        const debit = parseFloat(getCol(['Debit', 'Debit (PKR)', 'Debit(PKR)', 'DR', 'Dr Amount', 'Debit Amount', 'Dr'])) || 0;
                        const credit = parseFloat(getCol(['Credit', 'Credit (PKR)', 'Credit(PKR)', 'CR', 'Cr Amount', 'Credit Amount', 'Cr'])) || 0;
                        const balance = getCol(['Balance', 'Balance (PKR)', 'Running Balance']);
                        const drCr = getCol(['DR/CR', 'DRCR', 'DR CR', 'Type', 'Dr/Cr']);

                        // Calculate amount based on item type
                        let amount = 0;
                        if (item === "Black Scrape" || item === "White Scrape" || item === "Toka Scrape" || item === "Pig Scrape") {
                            amount = (weightQty / 37.324) * rate;
                        } else {
                            amount = weightQty * rate;
                        }

                        if (!customerName || (!debit && !credit)) return;

                        // Add customer if doesn't exist
                        if (!this.data.customers.find(c => c.name === customerName)) {
                            this.data.customers.push({
                                name: customerName,
                                balance: 0,
                                transactionCount: 0,
                                created: new Date().toISOString()
                            });
                        }

                        // Add transaction
                        const transaction = {
                            sn: sn || (this.data.transactions.length + 1),
                            date: date || new Date().toISOString().split('T')[0],
                            customer: customerName,
                            description: description || 'Imported Transaction',
                            item: item,
                            weightQty: weightQty,
                            rate: rate,
                            amount: amount,
                            transactionType: transactionType,
                            paymentMethod: paymentMethod,
                            bankName: bankName,
                            chequeNo: chequeNo,
                            debit: debit,
                            credit: credit,
                            drCr: drCr || (debit > 0 ? 'DR' : 'CR'),
                            timestamp: new Date().toISOString()
                        };

                        this.data.transactions.push(transaction);
                        
                        // Update balance
                        const customer = this.data.customers.find(c => c.name === customerName);
                        if (customer) {
                            customer.balance += debit - credit;
                            customer.transactionCount++;
                        }

                        importedCount++;
                    });

                    await this.saveData();
                    this.updateDashboard();
                    document.getElementById('importPreview').style.display = 'none';
                    this.showNotification(`Successfully imported ${importedCount} transactions!`, 'success');
                } catch (error) {
                    this.showNotification('Import error: ' + error.message, 'error');
                }
            }

            updateDashboard() {
                // Update stats
                document.getElementById('totalCustomers').textContent = this.data.customers.length;
                document.getElementById('totalTransactions').textContent = this.data.transactions.length;

                let totalDR = 0, totalCR = 0;
                this.data.customers.forEach(c => {
                    if (c.balance > 0) totalDR += c.balance;
                    else totalCR += Math.abs(c.balance);
                });

                document.getElementById('totalDR').textContent = `Rs. ${totalDR.toFixed(2)}`;
                document.getElementById('totalCR').textContent = `Rs. ${totalCR.toFixed(2)}`;
                document.getElementById('liveBalance').textContent = `Balance: Rs. ${(totalDR - totalCR).toFixed(2)}`;

                // Update recent transactions
                this.updateRecentTransactions();
                this.updateCustomerList();
                this.updateCustomerSelect();
            }

            updateRecentTransactions() {
                const tbody = document.getElementById('recentTransactions');
                const recent = this.data.transactions.slice(-10).reverse();

                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 2rem;">No transactions yet</td></tr>';
                    return;
                }

                tbody.innerHTML = recent.map(t => `
                    <tr>
                        <td>${t.sn}</td>
                        <td>${t.date}</td>
                        <td>${t.customer}</td>
                        <td>${t.description}</td>
                        <td>${t.item || '-'}</td>
                        <td>${t.weightQty ? t.weightQty.toFixed(2) : '-'}</td>
                        <td>${t.rate ? 'Rs. ' + t.rate.toFixed(2) : '-'}</td>
                        <td>${t.amount ? 'Rs. ' + t.amount.toFixed(2) : 'Rs. ' + (t.debit || t.credit).toFixed(2)}</td>
                        <td><span class="${t.drCr === 'DR' ? 'dr-badge' : 'cr-badge'}">${t.drCr}</span></td>
                    </tr>
                `).join('');
            }

            updateCustomerList() {
                const tbody = document.getElementById('customerList');
                if (this.data.customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No customers yet</td></tr>';
                    return;
                }

                tbody.innerHTML = this.data.customers.map(c => {
                    const transCount = this.data.transactions.filter(t => t.customer === c.name).length;
                    const drCr = c.balance >= 0 ? 'DR' : 'CR';
                    return `
                        <tr>
                            <td><strong>${c.name}</strong></td>
                            <td>Rs. ${Math.abs(c.balance).toFixed(2)}</td>
                            <td><span class="${drCr === 'DR' ? 'dr-badge' : 'cr-badge'}">${drCr}</span></td>
                            <td>${transCount}</td>
                            <td>
                                <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                        onclick="app.viewCustomerLedger('${c.name.replace(/'/g, "\\'")}')">View Ledger</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateCustomerSelect() {
                const select = document.getElementById('customerSelect');
                if (select) {
                    select.innerHTML = '<option value="">Select Customer</option>' + 
                        this.data.customers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
                }
            }

            viewCustomerLedger(customerName) {
                const customer = this.data.customers.find(c => c.name === customerName);
                const transactions = this.data.transactions.filter(t => t.customer === customerName);

                let html = `
                    <div class="modal-header">
                        <h3>Ledger: ${customerName}</h3>
                        <button class="close-btn" onclick="app.closeModal()">√ó</button>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Current Balance:</strong> 
                        Rs. ${Math.abs(customer.balance).toFixed(2)} 
                        <span class="${customer.balance >= 0 ? 'dr-badge' : 'cr-badge'}">
                            ${customer.balance >= 0 ? 'DR' : 'CR'}
                        </span>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>S.N</th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Item</th>
                                    <th>Weight/Qty</th>
                                    <th>Rate</th>
                                    <th>Amount</th>
                                    <th>Debit</th>
                                    <th>Credit</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody>`;

                let runningBalance = 0;
                transactions.forEach(t => {
                    runningBalance += t.debit - t.credit;
                    const amount = t.amount || (t.weightQty * t.rate) || (t.debit || t.credit);
                    html += `
                        <tr>
                            <td>${t.sn}</td>
                            <td>${t.date}</td>
                            <td>${t.description}</td>
                            <td>${t.item || '-'}</td>
                            <td>${t.weightQty ? t.weightQty.toFixed(2) : '-'}</td>
                            <td>${t.rate ? 'Rs. ' + t.rate.toFixed(2) : '-'}</td>
                            <td>${amount ? 'Rs. ' + amount.toFixed(2) : '-'}</td>
                            <td>${t.debit ? 'Rs. ' + t.debit.toFixed(2) : '-'}</td>
                            <td>${t.credit ? 'Rs. ' + t.credit.toFixed(2) : '-'}</td>
                            <td>Rs. ${Math.abs(runningBalance).toFixed(2)} ${runningBalance >= 0 ? 'DR' : 'CR'}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.exportCustomerLedger('${customerName.replace(/'/g, "\\'")}')">
                            üì§ Export Ledger
                        </button>
                        <button class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                    </div>`;

                this.showModal(html);
            }

            exportCustomerLedger(customerName) {
                const transactions = this.data.transactions.filter(t => t.customer === customerName);
                const ws = XLSX.utils.json_to_sheet(transactions);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, customerName.substring(0, 30));
                XLSX.writeFile(wb, `${customerName}_Ledger.xlsx`);
                this.showNotification('Ledger exported successfully!', 'success');
            }

            showModal(content) {
                const overlay = document.getElementById('modalOverlay');
                overlay.innerHTML = `<div class="modal">${content}</div>`;
                overlay.classList.add('active');
            }

            closeModal() {
                const overlay = document.getElementById('modalOverlay');
                overlay.classList.remove('active');
                overlay.innerHTML = '';
            }

            updateSyncStatus(status) {
                const el = document.getElementById('syncStatus');
                if (el) {
                    el.querySelector('span').textContent = status;
                }
            }

            startAutoSync() {
                setInterval(() => this.saveData(), 30000); // Auto-save every 30 seconds
                
                // Check if auto-sync is enabled
                if (this.data.googleSheetConfig && this.data.googleSheetConfig.autoSync) {
                    this.startGoogleSheetSync();
                }
            }

            // Google Sheets methods (simplified for now)
            async handleGoogleSheetsSubmit(form) {
                this.showNotification('Google Sheets integration is being improved. Please use file import for now.', 'warning');
            }

            loadGoogleSheetsConfig() {
                // Placeholder for Google Sheets config
            }

            updateGoogleSheetStatus() {
                // Placeholder for Google Sheets status
            }

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 5000);
            }
        }

        // Global functions
        let app;

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (window.innerWidth <= 768) {
                document.getElementById('mainNav').classList.remove('active');
            }
        }

        function clearForm() {
            document.getElementById('entryForm').reset();
            app.setDefaultDate();
            app.hideAmountCalculation();
        }

        async function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // Export transactions
            const ws1 = XLSX.utils.json_to_sheet(app.data.transactions);
            XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
            
            // Export customers
            const ws2 = XLSX.utils.json_to_sheet(app.data.customers);
            XLSX.utils.book_append_sheet(wb, ws2, 'Customers');
            
            XLSX.writeFile(wb, `Ledger_Complete_${new Date().toISOString().split('T')[0]}.xlsx`);
            app.showNotification('Data exported successfully!', 'success');
        }

        function viewBalanceSheet() {
            const customers = app.data.customers.map(c => ({
                Name: c.name,
                Balance: Math.abs(c.balance).toFixed(2),
                'DR/CR': c.balance >= 0 ? 'DR' : 'CR',
                Transactions: app.data.transactions.filter(t => t.customer === c.name).length
            }));

            let html = `
                <div class="modal-header">
                    <h3>Balance Sheet</h3>
                    <button class="close-btn" onclick="app.closeModal()">√ó</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Balance</th>
                                <th>DR/CR</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(c => `
                                <tr>
                                    <td>${c.Name}</td>
                                    <td>Rs. ${c.Balance}</td>
                                    <td><span class="${c['DR/CR'] === 'DR' ? 'dr-badge' : 'cr-badge'}">${c['DR/CR']}</span></td>
                                    <td>${c.Transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportBalanceSheet()">üì§ Export</button>
                    <button class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                </div>
            `;

            app.showModal(html);
        }

        function exportBalanceSheet() {
            const customers = app.data.customers.map(c => ({
                Name: c.name,
                Balance: Math.abs(c.balance).toFixed(2),
                'DR/CR': c.balance >= 0 ? 'DR' : 'CR'
            }));
            const ws = XLSX.utils.json_to_sheet(customers);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Balance Sheet');
            XLSX.writeFile(wb, `Balance_Sheet_${new Date().toISOString().split('T')[0]}.xlsx`);
            app.showNotification('Balance sheet exported!', 'success');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    app.data = { customers: [], transactions: [], lastSync: null, googleSheetConfig: null };
                    if (app.syncInterval) {
                        clearInterval(app.syncInterval);
                    }
                    app.saveData();
                    app.updateDashboard();
                    document.getElementById('syncStatusContainer').style.display = 'none';
                    app.showNotification('All data cleared', 'warning');
                }
            }
        }

        function testGoogleSheetConnection() {
            app.showNotification('Google Sheets integration is being improved. Please use file import for now.', 'warning');
        }

        function manualSync() {
            app.showNotification('Google Sheets integration is being improved. Please use file import for now.', 'warning');
        }

        function viewSyncLog() {
            app.showNotification('No sync log available yet.', 'warning');
        }

        function disconnectGoogleSheets() {
            app.showNotification('Google Sheets integration is being improved.', 'warning');
        }

        function showHelp() {
            app.showModal(`
                <div class="modal-header">
                    <h3>Help & Instructions</h3>
                    <button class="close-btn" onclick="app.closeModal()">√ó</button>
                </div>
                <div style="line-height: 1.8;">
                    <h4>How to Use:</h4>
                    <ol>
                        <li><strong>Add Customers:</strong> Go to Customers section and add your customers with opening balance</li>
                        <li><strong>Submit Entry:</strong> Record transactions with complete details</li>
                        <li><strong>Import Data:</strong> Upload Excel/CSV files with transaction data</li>
                        <li><strong>View Ledgers:</strong> Click on any customer to view their complete ledger</li>
                        <li><strong>Export:</strong> Export individual ledgers or complete data</li>
                    </ol>
                    
                    <h4>Amount Calculation:</h4>
                    <p><strong>For Scrap Items (Black Scrape, White Scrape, Toka Scrape, Pig Scrape):</strong></p>
                    <p>Amount = (Weight / 37.324) √ó Rate</p>
                    
                    <p><strong>For Other Items:</strong></p>
                    <p>Amount = Weight √ó Rate</p>
                    
                    <h4>Features:</h4>
                    <ul>
                        <li>‚úì Automatic amount calculation with scrap formula</li>
                        <li>‚úì Real-time calculation display</li>
                        <li>‚úì Offline support - works without internet</li>
                        <li>‚úì Auto-save every 30 seconds</li>
                        <li>‚úì Mobile & desktop responsive</li>
                        <li>‚úì Complete import/export functionality</li>
                        <li>‚úì Individual customer ledger views</li>
                        <li>‚úì Balance sheet with DR/CR indicators</li>
                    </ul>
                </div>
            `);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app = new LedgerApp();
        });
    </script>
</body>
</html>
