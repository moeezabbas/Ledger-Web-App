<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ledger Management System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --dr-color: #dc2626;
            --cr-color: #059669;
            --bg-light: #f8fafc;
            --bg-white: #ffffff;
            --text-dark: #1e293b;
            --text-light: #64748b;
            --border: #e2e8f0;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Header */
        .app-header {
            background: linear-gradient(135deg, var(--primary-dark), var(--primary));
            color: white;
            padding: 1rem 2rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-content h1 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .live-balance {
            background: rgba(255,255,255,0.2);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .mobile-toggle {
            display: none;
            background: none;
            border: none;
            color: white;
            font-size: 1.75rem;
            cursor: pointer;
            padding: 0.5rem;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .sync-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Navigation */
        .main-nav {
            width: 280px;
            background: var(--bg-white);
            padding: 1.5rem 1rem;
            margin-top: 76px;
            height: calc(100vh - 76px);
            position: fixed;
            left: 0;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.05);
            transition: transform 0.3s ease;
        }

        .nav-section {
            margin-bottom: 2rem;
        }

        .nav-section h3 {
            color: var(--primary);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .nav-btn {
            width: 100%;
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: var(--bg-white);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .nav-btn:hover {
            background: var(--bg-light);
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .nav-btn:active {
            transform: translateX(4px) scale(0.98);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            margin-top: 76px;
            padding: 2rem;
            min-height: calc(100vh - 76px);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Dashboard */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--bg-white);
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            font-size: 0.875rem;
            color: var(--text-light);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
        }

        /* Forms */
        .form-container {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.875rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--bg-white);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-secondary {
            background: var(--text-light);
            color: white;
        }

        .btn-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 1.5rem;
        }

        /* Tables */
        .table-container {
            background: var(--bg-white);
            border-radius: 12px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-top: 2rem;
        }

        .table-responsive {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th,
        .data-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            background: var(--primary);
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr:hover {
            background: var(--bg-light);
        }

        /* Balance indicators */
        .dr-badge {
            background: #fee2e2;
            color: var(--dr-color);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        .cr-badge {
            background: #d1fae5;
            color: var(--cr-color);
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.875rem;
        }

        /* Import Preview */
        .import-preview {
            background: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
        }

        .preview-table {
            width: 100%;
            font-size: 0.875rem;
        }

        .preview-table th,
        .preview-table td {
            padding: 0.5rem;
            border: 1px solid var(--border);
        }

        /* Notifications */
        .notification {
            position: fixed;
            top: 100px;
            right: 2rem;
            background: var(--bg-white);
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-lg);
            z-index: 2000;
            animation: slideIn 0.3s ease;
            max-width: 400px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--danger);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1999;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal {
            background: var(--bg-white);
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
        }

        @keyframes modalIn {
            from {
                transform: scale(0.9);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border);
        }

        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: var(--text-light);
            line-height: 1;
        }

        /* File Upload */
        .file-upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .file-upload-area:hover {
            border-color: var(--primary);
            background: var(--bg-light);
        }

        .file-upload-area.drag-over {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        /* Loading Spinner */
        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mobile Responsive */
        @media (max-width: 768px) {
            .mobile-toggle {
                display: block;
            }

            .main-nav {
                transform: translateX(-100%);
                width: 280px;
                z-index: 999;
            }

            .main-nav.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 1rem;
            }

            .header-content h1 {
                font-size: 1.2rem;
            }

            .live-balance {
                font-size: 0.875rem;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .btn-group {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }

            .data-table {
                font-size: 0.75rem;
            }

            .data-table th,
            .data-table td {
                padding: 0.5rem;
            }

            .modal {
                max-width: 95%;
                padding: 1.5rem;
            }

            .notification {
                right: 1rem;
                left: 1rem;
                max-width: none;
            }
        }

        @media (max-width: 480px) {
            .app-header {
                padding: 1rem;
            }

            .stat-number {
                font-size: 1.5rem;
            }

            .form-control {
                font-size: 16px; /* Prevent zoom on iOS */
            }
        }

        /* Print Styles */
        @media print {
            .app-header,
            .main-nav,
            .btn,
            .mobile-toggle {
                display: none !important;
            }

            .main-content {
                margin: 0;
                padding: 0;
            }

            .data-table {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="app-header">
            <div class="header-content">
                <div style="display: flex; align-items: center; gap: 1rem;">
                    <button class="mobile-toggle" id="mobileToggle">‚ò∞</button>
                    <h1>üìä Ledger Management System</h1>
                </div>
                <div class="header-actions">
                    <div class="sync-status" id="syncStatus">
                        <div class="sync-indicator"></div>
                        <span>Synced</span>
                    </div>
                    <span class="live-balance" id="liveBalance">Balance: Rs. 0</span>
                </div>
            </div>
        </header>

        <nav class="main-nav" id="mainNav">
            <div class="nav-section">
                <h3>üìä Operations</h3>
                <button class="nav-btn" onclick="showSection('dashboard')">üè† Dashboard</button>
                <button class="nav-btn" onclick="showSection('entry')">‚úì Submit Entry</button>
                <button class="nav-btn" onclick="showSection('customers')">üë• Customers</button>
            </div>

            <div class="nav-section">
                <h3>üíæ Data Management</h3>
                <button class="nav-btn" onclick="showSection('import')">üì• Import Data</button>
                <button class="nav-btn" onclick="showSection('google-sheets')">üîó Google Sheets Sync</button>
                <button class="nav-btn" onclick="exportAllData()">üì§ Export All</button>
                <button class="nav-btn" onclick="viewBalanceSheet()">üìä Balance Sheet</button>
            </div>

            <div class="nav-section">
                <h3>‚öôÔ∏è Settings</h3>
                <button class="nav-btn" onclick="clearAllData()">üóëÔ∏è Clear Data</button>
                <button class="nav-btn" onclick="showHelp()">‚ùì Help</button>
            </div>
        </nav>

        <main class="main-content" id="mainContent">
            <!-- Dashboard -->
            <div id="dashboard" class="section active">
                <h2 style="margin-bottom: 1.5rem;">Dashboard</h2>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <h3>Total Customers</h3>
                        <div class="stat-number" id="totalCustomers">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Transactions</h3>
                        <div class="stat-number" id="totalTransactions">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total DR Balance</h3>
                        <div class="stat-number" id="totalDR">Rs. 0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total CR Balance</h3>
                        <div class="stat-number" id="totalCR">Rs. 0</div>
                    </div>
                </div>

                <div class="table-container">
                    <h3 style="padding: 1rem; background: var(--bg-light);">Recent Transactions</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>S.N</th>
                                    <th>Date</th>
                                    <th>Customer</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>DR/CR</th>
                                </tr>
                            </thead>
                            <tbody id="recentTransactions">
                                <tr><td colspan="6" style="text-align: center; padding: 2rem;">No transactions yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Data Entry -->
            <div id="entry" class="section">
                <h2 style="margin-bottom: 1.5rem;">Submit Entry</h2>
                <div class="form-container">
                    <form id="entryForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Date *</label>
                                <input type="date" class="form-control" name="date" required>
                            </div>
                            <div class="form-group">
                                <label>Customer *</label>
                                <select class="form-control" name="customer" id="customerSelect" required>
                                    <option value="">Select Customer</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label>Description *</label>
                            <input type="text" class="form-control" name="description" placeholder="Transaction description" required>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Item</label>
                                <select class="form-control" name="item">
                                    <option value="">Select Item</option>
                                    <option>Chilled Gots</option>
                                    <option>Chilled Scrape</option>
                                    <option>Guides</option>
                                    <option>Chilled Rolls</option>
                                    <option>Fire Bricks</option>
                                    <option>H Oil</option>
                                    <option>Magnese</option>
                                    <option>Chrome</option>
                                    <option>Black Scrape</option>
                                    <option>White Scrape</option>
                                    <option>Toka Scrape</option>
                                    <option>Pig Scrape</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Weight/Qty</label>
                                <input type="number" class="form-control" name="weightQty" step="0.01" placeholder="0.00">
                            </div>
                            <div class="form-group">
                                <label>Rate (PKR)</label>
                                <input type="number" class="form-control" name="rate" step="0.01" placeholder="0.00">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Transaction Type *</label>
                                <select class="form-control" name="transactionType" required>
                                    <option>Sale</option>
                                    <option>Payment Received - Cash</option>
                                    <option>Payment Received - Bank</option>
                                    <option>Payment Given - Cash</option>
                                    <option>Payment Given - Bank</option>
                                    <option>Purchase</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Payment Method</label>
                                <select class="form-control" name="paymentMethod">
                                    <option>Cash</option>
                                    <option>Cheque</option>
                                    <option>Bank Transfer</option>
                                    <option>Jazzcash</option>
                                    <option>Easypaisa</option>
                                    <option>Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Bank Name</label>
                                <select class="form-control" name="bankName">
                                    <option value="">Select Bank</option>
                                    <option>HBL</option>
                                    <option>UBL</option>
                                    <option>MCB</option>
                                    <option>Allied Bank</option>
                                    <option>Bank Alfalah</option>
                                    <option>Meezan Bank</option>
                                    <option>Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Cheque No.</label>
                                <input type="text" class="form-control" name="chequeNo" placeholder="Cheque number">
                            </div>
                        </div>

                        <div class="form-grid">
                            <div class="form-group">
                                <label>Debit (PKR)</label>
                                <input type="number" class="form-control" name="debit" step="0.01" placeholder="0.00" id="debitInput">
                            </div>
                            <div class="form-group">
                                <label>Credit (PKR)</label>
                                <input type="number" class="form-control" name="credit" step="0.01" placeholder="0.00" id="creditInput">
                            </div>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">‚úì Submit Entry</button>
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('entryForm').reset()">Clear</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Customers -->
            <div id="customers" class="section">
                <h2 style="margin-bottom: 1.5rem;">Customer Management</h2>
                <div class="form-container" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Add New Customer</h3>
                    <form id="customerForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Customer Name *</label>
                                <input type="text" class="form-control" name="customerName" required>
                            </div>
                            <div class="form-group">
                                <label>Opening Balance</label>
                                <input type="number" class="form-control" name="openingBalance" step="0.01" value="0">
                            </div>
                            <div class="form-group">
                                <label>Balance Type</label>
                                <select class="form-control" name="balanceType">
                                    <option value="DR">DR (Customer Owes)</option>
                                    <option value="CR">CR (We Owe)</option>
                                </select>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-success">‚ûï Add Customer</button>
                    </form>
                </div>

                <div class="table-container">
                    <h3 style="padding: 1rem; background: var(--bg-light);">All Customers</h3>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Balance</th>
                                    <th>DR/CR</th>
                                    <th>Transactions</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="customerList">
                                <tr><td colspan="5" style="text-align: center; padding: 2rem;">No customers yet</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Import -->
            <div id="import" class="section">
                <h2 style="margin-bottom: 1.5rem;">Import Data</h2>
                <div class="form-container">
                    <div class="file-upload-area" id="dropZone">
                        <h3>üìÅ Drop Excel/CSV file here or click to browse</h3>
                        <p style="color: var(--text-light); margin-top: 0.5rem;">Supports .xlsx, .xls, .csv files</p>
                        <input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()" style="margin-top: 1rem;">Choose File</button>
                    </div>

                    <div id="importPreview" style="display: none;"></div>
                </div>
            </div>

            <!-- Google Sheets Sync -->
            <div id="google-sheets" class="section">
                <h2 style="margin-bottom: 1.5rem;">üîó Google Sheets Integration</h2>
                
                <div class="form-container" style="margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Connect to Google Sheets</h3>
                    <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                        Import ALL sheets (customer ledgers, transactions, balance sheet) from your Google Sheets workbook
                    </p>

                    <div style="background: var(--bg-light); padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 1rem;">üìã Setup Instructions:</h4>
                        <ol style="line-height: 2; padding-left: 1.5rem;">
                            <li>Open your Google Sheets ledger workbook</li>
                            <li>Click <strong>File ‚Üí Share ‚Üí Publish to web</strong></li>
                            <li>In "Link" tab, select <strong>"Entire Document"</strong></li>
                            <li>Choose <strong>Web page</strong> format</li>
                            <li>Click <strong>Publish</strong> and copy the published URL</li>
                            <li>Paste the URL below</li>
                        </ol>
                        <div style="background: #e3f2fd; padding: 1rem; border-radius: 6px; margin-top: 1rem; border-left: 4px solid var(--primary);">
                            <strong>üí° Important:</strong><br>
                            Make sure your Google Sheet is properly formatted with clear column headers like:
                            Date, Customer, Description, Debit, Credit, etc.
                        </div>
                    </div>

                    <form id="googleSheetsForm">
                        <div class="form-group">
                            <label>Published Google Sheets URL *</label>
                            <input type="text" class="form-control" name="sheetUrl" id="sheetUrl" 
                                   placeholder="https://docs.google.com/spreadsheets/d/..." required>
                            <small style="color: var(--text-light); display: block; margin-top: 0.5rem;">
                                Paste the URL from "Publish to web" not the edit URL
                            </small>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="autoSync" id="autoSync" style="margin-right: 0.5rem;">
                                Enable Auto-Sync (Check for updates every 5 minutes)
                            </label>
                        </div>

                        <div class="form-group">
                            <label>
                                <input type="checkbox" name="mergeData" id="mergeData" style="margin-right: 0.5rem;" checked>
                                Merge with existing data (uncheck to replace all data)
                            </label>
                        </div>

                        <div class="btn-group">
                            <button type="submit" class="btn btn-primary">üîó Connect & Import All Data</button>
                            <button type="button" class="btn btn-secondary" onclick="testGoogleSheetConnection()">
                                üß™ Test Connection
                            </button>
                        </div>
                    </form>
                </div>

                <div class="form-container" id="syncStatusContainer" style="display: none;">
                    <h3 style="margin-bottom: 1rem;">Sync Status</h3>
                    <div id="syncDetails" style="padding: 1rem; background: var(--bg-light); border-radius: 8px;">
                        <!-- Sync details will appear here -->
                    </div>
                    <div id="sheetsDiscovered" style="margin-top: 1rem;">
                        <!-- Sheets list will appear here -->
                    </div>
                    <div class="btn-group" style="margin-top: 1rem;">
                        <button class="btn btn-success" onclick="manualSync()">üîÑ Manual Sync Now</button>
                        <button class="btn btn-primary" onclick="viewSyncLog()">üìã View Sync Log</button>
                        <button class="btn btn-danger" onclick="disconnectGoogleSheets()">Disconnect</button>
                    </div>
                </div>

                <div class="form-container" style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">üí° What Gets Imported</h3>
                    <div style="display: grid; gap: 1rem;">
                        <div style="padding: 1rem; background: var(--bg-light); border-radius: 8px; border-left: 4px solid var(--success);">
                            <strong>‚úÖ All Transaction Data:</strong>
                            <p style="margin-top: 0.5rem; color: var(--text-light);">
                                Date, Customer, Description, Item, Weight/Qty, Rate, Transaction Type, Payment Method, Bank Name, Cheque No., Debit, Credit
                            </p>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-light); border-radius: 8px; border-left: 4px solid var(--success);">
                            <strong>‚úÖ Customer Information:</strong>
                            <p style="margin-top: 0.5rem; color: var(--text-light);">
                                All unique customers will be automatically created with their current balances
                            </p>
                        </div>
                        <div style="padding: 1rem; background: var(--bg-light); border-radius: 8px; border-left: 4px solid var(--success);">
                            <strong>‚úÖ Complete History:</strong>
                            <p style="margin-top: 0.5rem; color: var(--text-light);">
                                All transactions from all sheets will be imported with proper DR/CR calculations
                            </p>
                        </div>
                    </div>
                </div>

                <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--warning); margin-top: 2rem;">
                    <strong>‚ö†Ô∏è Troubleshooting Tips</strong>
                    <ul style="line-height: 1.8; padding-left: 1.5rem; color: var(--text-dark); margin-top: 0.5rem;">
                        <li>Make sure your Google Sheet is <strong>published to web</strong> (File ‚Üí Share ‚Üí Publish to web)</li>
                        <li>Use the published URL, not the edit URL</li>
                        <li>Ensure your sheet has proper column headers</li>
                        <li>First row should contain column names</li>
                        <li>Large sheets may take 30-60 seconds to import</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <div class="modal-overlay" id="modalOverlay"></div>

    <script>
        // Ledger Application with FIXED Google Sheets Integration
        class LedgerApp {
            constructor() {
                this.data = {
                    customers: [],
                    transactions: [],
                    lastSync: null,
                    googleSheetConfig: null
                };
                this.syncInterval = null;
                this.init();
            }

            async init() {
                await this.loadData();
                this.setupEventListeners();
                this.updateDashboard();
                this.startAutoSync();
                this.setDefaultDate();
            }

            setDefaultDate() {
                const dateInput = document.querySelector('input[name="date"]');
                if (dateInput) {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dateInput.value = `${year}-${month}-${day}`;
                }
            }

            async loadData() {
                try {
                    const saved = localStorage.getItem('ledger-data');
                    if (saved) {
                        this.data = JSON.parse(saved);
                        console.log('Data loaded successfully');
                    }
                } catch (error) {
                    console.log('No existing data found, starting fresh');
                }
            }

            async saveData() {
                try {
                    this.data.lastSync = new Date().toISOString();
                    localStorage.setItem('ledger-data', JSON.stringify(this.data));
                    this.updateSyncStatus('Synced');
                    return true;
                } catch (error) {
                    console.error('Save error:', error);
                    this.updateSyncStatus('Offline');
                    return false;
                }
            }

            setupEventListeners() {
                // Mobile navigation
                document.getElementById('mobileToggle').addEventListener('click', () => {
                    document.getElementById('mainNav').classList.toggle('active');
                });

                // Entry form
                document.getElementById('entryForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleEntrySubmit(e.target);
                });

                // Customer form
                document.getElementById('customerForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleCustomerSubmit(e.target);
                });

                // Google Sheets form
                document.getElementById('googleSheetsForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleGoogleSheetsSubmit(e.target);
                });

                // File import
                const fileInput = document.getElementById('fileInput');
                const dropZone = document.getElementById('dropZone');

                fileInput.addEventListener('change', (e) => this.handleFileSelect(e));
                
                dropZone.addEventListener('click', () => fileInput.click());
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('drag-over');
                });
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('drag-over');
                });
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('drag-over');
                    this.handleFileSelect({ target: { files: e.dataTransfer.files } });
                });

                // Debit/Credit mutual exclusion
                const debitInput = document.getElementById('debitInput');
                const creditInput = document.getElementById('creditInput');
                if (debitInput && creditInput) {
                    debitInput.addEventListener('input', (e) => {
                        if (e.target.value) {
                            creditInput.value = '';
                        }
                    });
                    creditInput.addEventListener('input', (e) => {
                        if (e.target.value) {
                            debitInput.value = '';
                        }
                    });
                }

                // Load saved Google Sheets config
                this.loadGoogleSheetsConfig();
            }

            async handleEntrySubmit(form) {
                const formData = new FormData(form);
                const debit = parseFloat(formData.get('debit')) || 0;
                const credit = parseFloat(formData.get('credit')) || 0;

                if (debit === 0 && credit === 0) {
                    this.showNotification('Please enter either Debit or Credit amount', 'error');
                    return;
                }

                const transaction = {
                    sn: this.data.transactions.length + 1,
                    date: formData.get('date'),
                    customer: formData.get('customer'),
                    description: formData.get('description'),
                    item: formData.get('item'),
                    weightQty: parseFloat(formData.get('weightQty')) || 0,
                    rate: parseFloat(formData.get('rate')) || 0,
                    transactionType: formData.get('transactionType'),
                    paymentMethod: formData.get('paymentMethod'),
                    bankName: formData.get('bankName'),
                    chequeNo: formData.get('chequeNo'),
                    debit: debit,
                    credit: credit,
                    drCr: debit > 0 ? 'DR' : 'CR',
                    timestamp: new Date().toISOString()
                };

                this.data.transactions.push(transaction);
                
                // Update customer balance
                const customer = this.data.customers.find(c => c.name === transaction.customer);
                if (customer) {
                    customer.balance += debit - credit;
                    customer.transactionCount = this.data.transactions.filter(t => t.customer === customer.name).length;
                }

                await this.saveData();
                this.updateDashboard();
                form.reset();
                this.setDefaultDate();
                this.showNotification('Transaction added successfully!', 'success');
            }

            async handleCustomerSubmit(form) {
                const formData = new FormData(form);
                const openingBalance = parseFloat(formData.get('openingBalance')) || 0;
                const balanceType = formData.get('balanceType');
                
                const customer = {
                    name: formData.get('customerName'),
                    balance: balanceType === 'DR' ? openingBalance : -openingBalance,
                    transactionCount: 0,
                    created: new Date().toISOString()
                };

                // Check for duplicates
                if (this.data.customers.some(c => c.name.toLowerCase() === customer.name.toLowerCase())) {
                    this.showNotification('Customer already exists!', 'error');
                    return;
                }

                this.data.customers.push(customer);
                await this.saveData();
                this.updateCustomerList();
                this.updateCustomerSelect();
                form.reset();
                this.showNotification('Customer added successfully!', 'success');
            }

            async handleFileSelect(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                        this.showImportPreview(jsonData);
                    } catch (error) {
                        this.showNotification('Error reading file: ' + error.message, 'error');
                    }
                };
                reader.readAsArrayBuffer(file);
            }

            showImportPreview(data) {
                const preview = document.getElementById('importPreview');
                const sampleData = data.slice(0, 5);

                let html = `
                    <div class="import-preview">
                        <h3>Import Preview (${data.length} records found)</h3>
                        <p style="color: var(--text-light); margin-bottom: 1rem;">First 5 rows:</p>
                        <div class="table-responsive">
                            <table class="preview-table">
                                <thead><tr>`;

                if (sampleData.length > 0) {
                    Object.keys(sampleData[0]).forEach(key => {
                        html += `<th>${key}</th>`;
                    });
                    html += `</tr></thead><tbody>`;

                    sampleData.forEach(row => {
                        html += '<tr>';
                        Object.values(row).forEach(val => {
                            html += `<td>${val || ''}</td>`;
                        });
                        html += '</tr>';
                    });
                }

                html += `</tbody></table></div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="app.confirmImport(${JSON.stringify(data).replace(/"/g, '&quot;')})">
                            ‚úì Confirm Import
                        </button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importPreview').style.display='none'">
                            Cancel
                        </button>
                    </div>
                </div>`;

                preview.innerHTML = html;
                preview.style.display = 'block';
            }

            async confirmImport(data) {
                try {
                    let importedCount = 0;

                    data.forEach(row => {
                        // Map column names (case-insensitive)
                        const getCol = (names) => {
                            for (let name of names) {
                                const key = Object.keys(row).find(k => 
                                    k.toLowerCase().trim() === name.toLowerCase()
                                );
                                if (key && row[key]) return row[key];
                            }
                            return '';
                        };

                        const customerName = getCol(['Customer', 'Name', 'Party Name', 'Account']);
                        const date = getCol(['Date', 'Transaction Date', 'Dated']);
                        const description = getCol(['Description', 'Particulars', 'Details', 'Narration']);
                        const debit = parseFloat(getCol(['Debit', 'Debit (PKR)', 'DR', 'Dr Amount'])) || 0;
                        const credit = parseFloat(getCol(['Credit', 'Credit (PKR)', 'CR', 'Cr Amount'])) || 0;

                        if (!customerName || (!debit && !credit)) return;

                        // Add customer if doesn't exist
                        if (!this.data.customers.find(c => c.name === customerName)) {
                            this.data.customers.push({
                                name: customerName,
                                balance: 0,
                                transactionCount: 0,
                                created: new Date().toISOString()
                            });
                        }

                        // Add transaction
                        const transaction = {
                            sn: this.data.transactions.length + 1,
                            date: date || new Date().toISOString().split('T')[0],
                            customer: customerName,
                            description: description || 'Imported Transaction',
                            item: getCol(['Item', 'Product', 'Goods']),
                            weightQty: parseFloat(getCol(['Weight/Qty', 'Quantity', 'Weight', 'Qty'])) || 0,
                            rate: parseFloat(getCol(['Rate', 'Rate (PKR)', 'Price', 'Unit Price'])) || 0,
                            transactionType: getCol(['Transaction Type', 'Type', 'Trans Type']),
                            paymentMethod: getCol(['Payment Method', 'Method', 'Mode']),
                            bankName: getCol(['Bank Name', 'Bank']),
                            chequeNo: getCol(['Cheque No', 'Cheque No.', 'Check No']),
                            debit: debit,
                            credit: credit,
                            drCr: getCol(['DR/CR', 'DRCR', 'Type']) || (debit > 0 ? 'DR' : 'CR'),
                            timestamp: new Date().toISOString()
                        };

                        this.data.transactions.push(transaction);
                        
                        // Update balance
                        const customer = this.data.customers.find(c => c.name === customerName);
                        if (customer) {
                            customer.balance += debit - credit;
                            customer.transactionCount++;
                        }

                        importedCount++;
                    });

                    await this.saveData();
                    this.updateDashboard();
                    document.getElementById('importPreview').style.display = 'none';
                    this.showNotification(`Successfully imported ${importedCount} transactions!`, 'success');
                } catch (error) {
                    this.showNotification('Import error: ' + error.message, 'error');
                }
            }

            updateDashboard() {
                // Update stats
                document.getElementById('totalCustomers').textContent = this.data.customers.length;
                document.getElementById('totalTransactions').textContent = this.data.transactions.length;

                let totalDR = 0, totalCR = 0;
                this.data.customers.forEach(c => {
                    if (c.balance > 0) totalDR += c.balance;
                    else totalCR += Math.abs(c.balance);
                });

                document.getElementById('totalDR').textContent = `Rs. ${totalDR.toFixed(2)}`;
                document.getElementById('totalCR').textContent = `Rs. ${totalCR.toFixed(2)}`;
                document.getElementById('liveBalance').textContent = `Balance: Rs. ${(totalDR - totalCR).toFixed(2)}`;

                // Update recent transactions
                this.updateRecentTransactions();
                this.updateCustomerList();
                this.updateCustomerSelect();
            }

            updateRecentTransactions() {
                const tbody = document.getElementById('recentTransactions');
                const recent = this.data.transactions.slice(-10).reverse();

                if (recent.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 2rem;">No transactions yet</td></tr>';
                    return;
                }

                tbody.innerHTML = recent.map(t => `
                    <tr>
                        <td>${t.sn}</td>
                        <td>${t.date}</td>
                        <td>${t.customer}</td>
                        <td>${t.description}</td>
                        <td>Rs. ${(t.debit || t.credit).toFixed(2)}</td>
                        <td><span class="${t.drCr === 'DR' ? 'dr-badge' : 'cr-badge'}">${t.drCr}</span></td>
                    </tr>
                `).join('');
            }

            updateCustomerList() {
                const tbody = document.getElementById('customerList');
                if (this.data.customers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 2rem;">No customers yet</td></tr>';
                    return;
                }

                tbody.innerHTML = this.data.customers.map(c => {
                    const transCount = this.data.transactions.filter(t => t.customer === c.name).length;
                    const drCr = c.balance >= 0 ? 'DR' : 'CR';
                    return `
                        <tr>
                            <td><strong>${c.name}</strong></td>
                            <td>Rs. ${Math.abs(c.balance).toFixed(2)}</td>
                            <td><span class="${drCr === 'DR' ? 'dr-badge' : 'cr-badge'}">${drCr}</span></td>
                            <td>${transCount}</td>
                            <td>
                                <button class="btn btn-primary" style="padding: 0.5rem 1rem; font-size: 0.875rem;" 
                                        onclick="app.viewCustomerLedger('${c.name.replace(/'/g, "\\'")}')">View Ledger</button>
                            </td>
                        </tr>
                    `;
                }).join('');
            }

            updateCustomerSelect() {
                const select = document.getElementById('customerSelect');
                select.innerHTML = '<option value="">Select Customer</option>' + 
                    this.data.customers.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
            }

            viewCustomerLedger(customerName) {
                const customer = this.data.customers.find(c => c.name === customerName);
                const transactions = this.data.transactions.filter(t => t.customer === customerName);

                let html = `
                    <div class="modal-header">
                        <h3>Ledger: ${customerName}</h3>
                        <button class="close-btn" onclick="app.closeModal()">√ó</button>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <strong>Current Balance:</strong> 
                        Rs. ${Math.abs(customer.balance).toFixed(2)} 
                        <span class="${customer.balance >= 0 ? 'dr-badge' : 'cr-badge'}">
                            ${customer.balance >= 0 ? 'DR' : 'CR'}
                        </span>
                    </div>
                    <div class="table-responsive">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>S.N</th>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Item</th>
                                    <th>Debit</th>
                                    <th>Credit</th>
                                    <th>Balance</th>
                                </tr>
                            </thead>
                            <tbody>`;

                let runningBalance = 0;
                transactions.forEach(t => {
                    runningBalance += t.debit - t.credit;
                    html += `
                        <tr>
                            <td>${t.sn}</td>
                            <td>${t.date}</td>
                            <td>${t.description}</td>
                            <td>${t.item || '-'}</td>
                            <td>${t.debit ? 'Rs. ' + t.debit.toFixed(2) : '-'}</td>
                            <td>${t.credit ? 'Rs. ' + t.credit.toFixed(2) : '-'}</td>
                            <td>Rs. ${Math.abs(runningBalance).toFixed(2)} ${runningBalance >= 0 ? 'DR' : 'CR'}</td>
                        </tr>
                    `;
                });

                html += `</tbody></table></div>
                    <div class="btn-group">
                        <button class="btn btn-primary" onclick="app.exportCustomerLedger('${customerName.replace(/'/g, "\\'")}')">
                            üì§ Export Ledger
                        </button>
                        <button class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                    </div>`;

                this.showModal(html);
            }

            exportCustomerLedger(customerName) {
                const transactions = this.data.transactions.filter(t => t.customer === customerName);
                const ws = XLSX.utils.json_to_sheet(transactions);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, customerName.substring(0, 30));
                XLSX.writeFile(wb, `${customerName}_Ledger.xlsx`);
                this.showNotification('Ledger exported successfully!', 'success');
            }

            showModal(content) {
                const overlay = document.getElementById('modalOverlay');
                overlay.innerHTML = `<div class="modal">${content}</div>`;
                overlay.classList.add('active');
            }

            closeModal() {
                const overlay = document.getElementById('modalOverlay');
                overlay.classList.remove('active');
                overlay.innerHTML = '';
            }

            updateSyncStatus(status) {
                const el = document.getElementById('syncStatus');
                el.querySelector('span').textContent = status;
            }

            startAutoSync() {
                setInterval(() => this.saveData(), 30000); // Auto-save every 30 seconds
                
                // Check if auto-sync is enabled
                if (this.data.googleSheetConfig && this.data.googleSheetConfig.autoSync) {
                    this.startGoogleSheetSync();
                }
            }

            // FIXED GOOGLE SHEETS METHODS
            async handleGoogleSheetsSubmit(form) {
                const formData = new FormData(form);
                const sheetUrl = formData.get('sheetUrl');
                const autoSync = formData.get('autoSync') === 'on';
                const mergeData = formData.get('mergeData') === 'on';

                this.showNotification('üîÑ Connecting to Google Sheets and importing data...', 'warning');

                try {
                    // Extract spreadsheet ID from URL
                    const spreadsheetId = this.extractSpreadsheetId(sheetUrl);
                    if (!spreadsheetId) {
                        throw new Error('Invalid Google Sheets URL. Please use the published URL.');
                    }

                    // Import data from Google Sheets
                    const importedData = await this.importFromGoogleSheets(spreadsheetId, mergeData);
                    
                    // Save configuration
                    this.data.googleSheetConfig = {
                        url: sheetUrl,
                        spreadsheetId: spreadsheetId,
                        autoSync: autoSync,
                        mergeData: mergeData,
                        lastSync: new Date().toISOString(),
                        syncLog: [`Imported ${importedData.transactions} transactions and ${importedData.customers} customers on ${new Date().toLocaleString()}`]
                    };

                    await this.saveData();
                    
                    // Update UI
                    this.updateGoogleSheetStatus();
                    this.updateDashboard();
                    
                    if (autoSync) {
                        this.startGoogleSheetSync();
                    }

                    this.showNotification(`‚úÖ Successfully imported ${importedData.transactions} transactions for ${importedData.customers} customers!`, 'success');
                    
                } catch (error) {
                    this.showNotification('‚ùå Import failed: ' + error.message, 'error');
                    console.error('Google Sheets import error:', error);
                }
            }

            extractSpreadsheetId(url) {
                // Extract ID from Google Sheets URL
                const patterns = [
                    /\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/,
                    /\/d\/([a-zA-Z0-9-_]+)\//,
                    /^([a-zA-Z0-9-_]+)$/
                ];
                
                for (let pattern of patterns) {
                    const match = url.match(pattern);
                    if (match) return match[1];
                }
                
                return null;
            }

            async importFromGoogleSheets(spreadsheetId, mergeData = true) {
                try {
                    this.showNotification('üì• Downloading data from Google Sheets...', 'warning');

                    // Use CORS proxy to avoid CORS issues
                    const proxyUrl = 'https://corsproxy.io/?';
                    const csvUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                    
                    const response = await fetch(proxyUrl + encodeURIComponent(csvUrl));
                    if (!response.ok) {
                        throw new Error(`Failed to download sheet: ${response.status} ${response.statusText}`);
                    }

                    const csvText = await response.text();
                    
                    if (!csvText || csvText.length < 10) {
                        throw new Error('Sheet appears to be empty or inaccessible');
                    }

                    // Parse CSV data
                    const data = this.parseCSV(csvText);
                    
                    if (data.length === 0) {
                        throw new Error('No data found in the sheet');
                    }

                    this.showNotification(`üìä Processing ${data.length} rows...`, 'warning');

                    // Clear existing data if not merging
                    if (!mergeData) {
                        this.data.transactions = [];
                        this.data.customers = [];
                    }

                    // Process the data
                    let importedTransactions = 0;
                    let importedCustomers = 0;

                    data.forEach((row, index) => {
                        // Skip header row if it exists
                        if (index === 0 && this.isHeaderRow(row)) {
                            return;
                        }

                        // Map columns (case-insensitive)
                        const getValue = (possibleNames) => {
                            for (const name of possibleNames) {
                                const key = Object.keys(row).find(k => 
                                    k.toLowerCase().includes(name.toLowerCase())
                                );
                                if (key && row[key] !== undefined && row[key] !== '') {
                                    return row[key];
                                }
                            }
                            return '';
                        };

                        const customerName = getValue(['customer', 'name', 'party', 'account']);
                        const date = getValue(['date', 'transaction date', 'dated']);
                        const description = getValue(['description', 'particulars', 'narration', 'details']);
                        const debit = parseFloat(getValue(['debit', 'dr', 'debit amount'])) || 0;
                        const credit = parseFloat(getValue(['credit', 'cr', 'credit amount'])) || 0;
                        const item = getValue(['item', 'product', 'goods']);
                        const weightQty = parseFloat(getValue(['weight', 'qty', 'quantity', 'weight/qty'])) || 0;
                        const rate = parseFloat(getValue(['rate', 'price', 'unit price'])) || 0;
                        const transactionType = getValue(['type', 'transaction type', 'transaction']);
                        const paymentMethod = getValue(['payment', 'method', 'payment method', 'mode']);
                        const bankName = getValue(['bank', 'bank name']);
                        const chequeNo = getValue(['cheque', 'cheque no', 'check no']);

                        // Skip if no customer or no transaction amount
                        if (!customerName || (debit === 0 && credit === 0)) {
                            return;
                        }

                        // Add customer if doesn't exist
                        let customer = this.data.customers.find(c => c.name.toLowerCase() === customerName.toLowerCase());
                        if (!customer) {
                            customer = {
                                name: customerName,
                                balance: 0,
                                transactionCount: 0,
                                created: new Date().toISOString()
                            };
                            this.data.customers.push(customer);
                            importedCustomers++;
                        }

                        // Create transaction
                        const transaction = {
                            sn: this.data.transactions.length + 1,
                            date: date || new Date().toISOString().split('T')[0],
                            customer: customerName,
                            description: description || 'Imported from Google Sheets',
                            item: item,
                            weightQty: weightQty,
                            rate: rate,
                            transactionType: transactionType,
                            paymentMethod: paymentMethod,
                            bankName: bankName,
                            chequeNo: chequeNo,
                            debit: debit,
                            credit: credit,
                            drCr: debit > 0 ? 'DR' : 'CR',
                            timestamp: new Date().toISOString(),
                            source: 'google-sheets'
                        };

                        this.data.transactions.push(transaction);
                        
                        // Update customer balance
                        customer.balance += debit - credit;
                        customer.transactionCount++;

                        importedTransactions++;
                    });

                    if (importedTransactions === 0) {
                        throw new Error('No valid transactions found. Check your column headers.');
                    }

                    return {
                        transactions: importedTransactions,
                        customers: importedCustomers
                    };

                } catch (error) {
                    throw new Error(`Failed to import from Google Sheets: ${error.message}`);
                }
            }

            isHeaderRow(row) {
                const values = Object.values(row).map(v => v.toString().toLowerCase());
                const headerIndicators = ['date', 'customer', 'debit', 'credit', 'description', 'amount'];
                return headerIndicators.some(header => 
                    values.some(value => value.includes(header))
                );
            }

            parseCSV(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) return [];

                // Detect delimiter
                const firstLine = lines[0];
                const commaCount = (firstLine.match(/,/g) || []).length;
                const semicolonCount = (firstLine.match(/;/g) || []).length;
                const delimiter = commaCount > semicolonCount ? ',' : ';';

                const headers = lines[0].split(delimiter).map(h => h.trim().replace(/^"|"$/g, ''));

                return lines.slice(1).map(line => {
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let char of line) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === delimiter && !inQuotes) {
                            values.push(current.trim().replace(/^"|"$/g, ''));
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim().replace(/^"|"$/g, ''));
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        if (header && header.trim() !== '') {
                            row[header] = values[index] || '';
                        }
                    });
                    return row;
                }).filter(row => Object.keys(row).length > 0);
            }

            startGoogleSheetSync() {
                if (this.syncInterval) {
                    clearInterval(this.syncInterval);
                }

                if (this.data.googleSheetConfig && this.data.googleSheetConfig.autoSync) {
                    this.syncInterval = setInterval(() => {
                        this.syncWithGoogleSheet();
                    }, 5 * 60 * 1000); // 5 minutes

                    this.showNotification('Auto-sync enabled - checking every 5 minutes', 'success');
                }
            }

            async syncWithGoogleSheet() {
                if (!this.data.googleSheetConfig) return;

                try {
                    this.updateSyncStatus('Syncing...');
                    
                    const spreadsheetId = this.data.googleSheetConfig.spreadsheetId;
                    const mergeData = this.data.googleSheetConfig.mergeData;
                    
                    const result = await this.importFromGoogleSheets(spreadsheetId, mergeData);
                    
                    this.data.googleSheetConfig.lastSync = new Date().toISOString();
                    this.data.googleSheetConfig.syncLog.push(`Auto-sync: ${result.transactions} transactions, ${result.customers} customers at ${new Date().toLocaleString()}`);
                    
                    await this.saveData();
                    this.updateGoogleSheetStatus();
                    this.updateDashboard();
                    this.updateSyncStatus('Synced');
                    
                    this.showNotification('‚úÖ Auto-sync completed successfully', 'success');
                } catch (error) {
                    console.error('Auto-sync error:', error);
                    this.updateSyncStatus('Sync Failed');
                    this.showNotification('Auto-sync failed: ' + error.message, 'error');
                }
            }

            loadGoogleSheetsConfig() {
                if (this.data.googleSheetConfig) {
                    document.getElementById('sheetUrl').value = this.data.googleSheetConfig.url;
                    document.getElementById('autoSync').checked = this.data.googleSheetConfig.autoSync;
                    document.getElementById('mergeData').checked = this.data.googleSheetConfig.mergeData;
                    this.updateGoogleSheetStatus();
                }
            }

            updateGoogleSheetStatus() {
                const container = document.getElementById('syncStatusContainer');
                const details = document.getElementById('syncDetails');

                if (this.data.googleSheetConfig) {
                    container.style.display = 'block';
                    const lastSync = new Date(this.data.googleSheetConfig.lastSync);
                    
                    details.innerHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div><strong>Status:</strong> <span style="color: var(--success);">‚úì Connected</span></div>
                            <div><strong>Auto-Sync:</strong> ${this.data.googleSheetConfig.autoSync ? 'üîÑ Enabled' : '‚è∏ Disabled'}</div>
                            <div><strong>Last Sync:</strong> ${lastSync.toLocaleString()}</div>
                            <div><strong>Customers:</strong> ${this.data.customers.length}</div>
                            <div><strong>Transactions:</strong> ${this.data.transactions.length}</div>
                            <div><strong>Data Mode:</strong> ${this.data.googleSheetConfig.mergeData ? 'Merge' : 'Replace'}</div>
                        </div>
                    `;
                } else {
                    container.style.display = 'none';
                }
            }

            showNotification(message, type = 'success') {
                const notif = document.createElement('div');
                notif.className = `notification ${type}`;
                notif.textContent = message;
                document.body.appendChild(notif);
                setTimeout(() => notif.remove(), 5000);
            }
        }

        // Global functions
        let app;

        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            if (window.innerWidth <= 768) {
                document.getElementById('mainNav').classList.remove('active');
            }
        }

        async function exportAllData() {
            const wb = XLSX.utils.book_new();
            
            // Export transactions
            const ws1 = XLSX.utils.json_to_sheet(app.data.transactions);
            XLSX.utils.book_append_sheet(wb, ws1, 'Transactions');
            
            // Export customers
            const ws2 = XLSX.utils.json_to_sheet(app.data.customers);
            XLSX.utils.book_append_sheet(wb, ws2, 'Customers');
            
            XLSX.writeFile(wb, `Ledger_Complete_${new Date().toISOString().split('T')[0]}.xlsx`);
            app.showNotification('Data exported successfully!', 'success');
        }

        function viewBalanceSheet() {
            const customers = app.data.customers.map(c => ({
                Name: c.name,
                Balance: Math.abs(c.balance).toFixed(2),
                'DR/CR': c.balance >= 0 ? 'DR' : 'CR',
                Transactions: app.data.transactions.filter(t => t.customer === c.name).length
            }));

            let html = `
                <div class="modal-header">
                    <h3>Balance Sheet</h3>
                    <button class="close-btn" onclick="app.closeModal()">√ó</button>
                </div>
                <div class="table-responsive">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Customer</th>
                                <th>Balance</th>
                                <th>DR/CR</th>
                                <th>Transactions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(c => `
                                <tr>
                                    <td>${c.Name}</td>
                                    <td>Rs. ${c.Balance}</td>
                                    <td><span class="${c['DR/CR'] === 'DR' ? 'dr-badge' : 'cr-badge'}">${c['DR/CR']}</span></td>
                                    <td>${c.Transactions}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
                <div class="btn-group">
                    <button class="btn btn-success" onclick="exportBalanceSheet()">üì§ Export</button>
                    <button class="btn btn-secondary" onclick="app.closeModal()">Close</button>
                </div>
            `;

            app.showModal(html);
        }

        function exportBalanceSheet() {
            const customers = app.data.customers.map(c => ({
                Name: c.name,
                Balance: Math.abs(c.balance).toFixed(2),
                'DR/CR': c.balance >= 0 ? 'DR' : 'CR'
            }));
            const ws = XLSX.utils.json_to_sheet(customers);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Balance Sheet');
            XLSX.writeFile(wb, `Balance_Sheet_${new Date().toISOString().split('T')[0]}.xlsx`);
            app.showNotification('Balance sheet exported!', 'success');
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
                if (confirm('Final confirmation: Delete everything?')) {
                    app.data = { customers: [], transactions: [], lastSync: null, googleSheetConfig: null };
                    if (app.syncInterval) {
                        clearInterval(app.syncInterval);
                    }
                    app.saveData();
                    app.updateDashboard();
                    document.getElementById('syncStatusContainer').style.display = 'none';
                    app.showNotification('All data cleared', 'warning');
                }
            }
        }

        async function testGoogleSheetConnection() {
            const sheetUrl = document.getElementById('sheetUrl').value;
            
            if (!sheetUrl) {
                app.showNotification('Please enter a Google Sheets URL', 'error');
                return;
            }

            app.showNotification('üß™ Testing connection to Google Sheets...', 'warning');

            try {
                const spreadsheetId = app.extractSpreadsheetId(sheetUrl);
                if (!spreadsheetId) {
                    throw new Error('Invalid Google Sheets URL format');
                }

                // Test connection
                const proxyUrl = 'https://corsproxy.io/?';
                const testUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/export?format=csv`;
                
                const response = await fetch(proxyUrl + encodeURIComponent(testUrl));
                
                if (!response.ok) {
                    throw new Error(`Cannot access spreadsheet: ${response.status}`);
                }
                
                const csvText = await response.text();
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                
                if (lines.length === 0) {
                    throw new Error('Spreadsheet is empty');
                }

                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                const sampleData = lines.slice(1, 4).map(line => line.split(',').map(cell => cell.trim().replace(/^"|"$/g, '')));

                app.showModal(`
                    <div class="modal-header">
                        <h3>‚úÖ Connection Successful!</h3>
                        <button class="close-btn" onclick="app.closeModal()">√ó</button>
                    </div>
                    <div>
                        <p style="margin-bottom: 1rem;"><strong>Google Sheets is accessible!</strong></p>
                        <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px;">
                            <p><strong>üìä Rows Found:</strong> ${lines.length - 1} data rows</p>
                            <p><strong>üìã Columns Detected:</strong> ${headers.length} columns</p>
                            <p><strong>üîç Sample Data Preview:</strong></p>
                            <div style="overflow-x: auto; margin-top: 0.5rem;">
                                <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                                    <thead>
                                        <tr style="background: var(--primary); color: white;">
                                            ${headers.map(h => `<th style="padding: 0.5rem; border: 1px solid var(--border);">${h}</th>`).join('')}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${sampleData.map(row => `
                                            <tr>
                                                ${row.map(cell => `<td style="padding: 0.5rem; border: 1px solid var(--border);">${cell}</td>`).join('')}
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div style="background: #d1f2eb; padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid var(--success);">
                            <strong>‚úì Ready to import!</strong>
                            <p style="margin-top: 0.5rem;">Click "Connect & Import All Data" to import all transactions.</p>
                        </div>
                    </div>
                `);
            } catch (error) {
                app.showModal(`
                    <div class="modal-header">
                        <h3>‚ùå Connection Failed</h3>
                        <button class="close-btn" onclick="app.closeModal()">√ó</button>
                    </div>
                    <div>
                        <p style="color: var(--danger); margin-bottom: 1rem;"><strong>Cannot connect to Google Sheet</strong></p>
                        <p style="margin-bottom: 1rem;">Error: ${error.message}</p>
                        <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; border-left: 4px solid var(--warning);">
                            <strong>‚ö†Ô∏è Quick Fix:</strong>
                            <ol style="margin-top: 0.5rem; padding-left: 1.5rem; line-height: 2;">
                                <li>Open your Google Sheets workbook</li>
                                <li>Click <strong>File ‚Üí Share ‚Üí Publish to web</strong></li>
                                <li>Select <strong>"Entire Document"</strong></li>
                                <li>Choose <strong>Web page</strong> format</li>
                                <li>Click <strong>Publish</strong></li>
                                <li>Copy the published URL and paste it above</li>
                            </ol>
                        </div>
                    </div>
                `);
            }
        }

        async function manualSync() {
            if (!app.data.googleSheetConfig) {
                app.showNotification('Not connected to Google Sheets', 'error');
                return;
            }
            
            app.showNotification('üîÑ Starting manual sync from Google Sheets...', 'warning');
            await app.syncWithGoogleSheet();
        }

        function viewSyncLog() {
            if (!app.data.googleSheetConfig || !app.data.googleSheetConfig.syncLog) {
                app.showNotification('No sync log available', 'warning');
                return;
            }

            const log = app.data.googleSheetConfig.syncLog.join('<br>');
            
            app.showModal(`
                <div class="modal-header">
                    <h3>üìã Sync Log</h3>
                    <button class="close-btn" onclick="app.closeModal()">√ó</button>
                </div>
                <div style="max-height: 400px; overflow-y: auto;">
                    <div style="background: var(--bg-light); padding: 1rem; border-radius: 8px; font-size: 0.875rem; line-height: 1.6;">${log}</div>
                </div>
            `);
        }

        function disconnectGoogleSheets() {
            if (confirm('Disconnect from Google Sheets? (Your imported data will remain)')) {
                app.data.googleSheetConfig = null;
                if (app.syncInterval) {
                    clearInterval(app.syncInterval);
                    app.syncInterval = null;
                }
                app.saveData();
                document.getElementById('syncStatusContainer').style.display = 'none';
                document.getElementById('googleSheetsForm').reset();
                app.showNotification('Disconnected from Google Sheets', 'success');
            }
        }

        function showHelp() {
            app.showModal(`
                <div class="modal-header">
                    <h3>Help & Instructions</h3>
                    <button class="close-btn" onclick="app.closeModal()">√ó</button>
                </div>
                <div style="line-height: 1.8;">
                    <h4>How to Use:</h4>
                    <ol>
                        <li><strong>Add Customers:</strong> Go to Customers section and add your customers with opening balance</li>
                        <li><strong>Submit Entry:</strong> Record transactions with complete details including items, rates, payment methods</li>
                        <li><strong>Import Data:</strong> Upload Excel/CSV files with columns: S.N, Date, Description, Item, Weight/Qty, Rate, Transaction Type, Payment Method, Bank Name, Cheque No., Debit, Credit, DR/CR</li>
                        <li><strong>Google Sheets Sync:</strong> Connect your Google Sheets ledger for automatic data import</li>
                        <li><strong>View Ledgers:</strong> Click on any customer to view their complete ledger</li>
                        <li><strong>Export:</strong> Export individual ledgers or complete data</li>
                    </ol>
                    <h4>Google Sheets Integration:</h4>
                    <ul>
                        <li><strong>Step 1:</strong> Open your Google Sheets ledger</li>
                        <li><strong>Step 2:</strong> Click File ‚Üí Share ‚Üí Publish to web</li>
                        <li><strong>Step 3:</strong> Select "Entire Document"</li>
                        <li><strong>Step 4:</strong> Choose "Web page" format</li>
                        <li><strong>Step 5:</strong> Click Publish and copy the published URL</li>
                        <li><strong>Step 6:</strong> Paste in Google Sheets Sync section</li>
                    </ul>
                    <h4>Column Names Supported:</h4>
                    <ul>
                        <li><strong>Customer:</strong> Customer, Name, Party Name, Account, Customer Name</li>
                        <li><strong>Date:</strong> Date, Transaction Date, Dated</li>
                        <li><strong>Description:</strong> Description, Particulars, Details, Narration</li>
                        <li><strong>Debit:</strong> Debit, Debit (PKR), DR, Dr Amount</li>
                        <li><strong>Credit:</strong> Credit, Credit (PKR), CR, Cr Amount</li>
                        <li><strong>Item:</strong> Item, Product, Goods</li>
                        <li><strong>Weight/Qty:</strong> Weight/Qty, Quantity, Weight, Qty</li>
                        <li><strong>Rate:</strong> Rate, Rate (PKR), Price, Unit Price</li>
                        <li><strong>Bank:</strong> Bank Name, Bank</li>
                        <li><strong>Cheque:</strong> Cheque No, Cheque No., Check No</li>
                    </ul>
                    <h4>Features:</h4>
                    <ul>
                        <li>‚úì Offline support - works without internet</li>
                        <li>‚úì Auto-save every 30 seconds</li>
                        <li>‚úì Google Sheets integration with auto-sync</li>
                        <li>‚úì Mobile & desktop responsive</li>
                        <li>‚úì Complete import/export functionality</li>
                        <li>‚úì Individual customer ledger views</li>
                        <li>‚úì Balance sheet with DR/CR indicators</li>
                    </ul>
                </div>
            `);
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            app = new LedgerApp();
        });
    </script>
</body>
</html>
