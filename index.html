<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abbas Sons Roll Tech - Ledger System</title>
    <!-- Add Excel library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title {
            font-size: 28px;
            font-weight: bold;
        }
        
        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }
        
        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            transition: all 0.3s;
        }
        
        .nav-tab:hover {
            background: #e9ecef;
            color: #667eea;
        }
        
        .nav-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }
        
        .content-area {
            padding: 30px;
            min-height: 500px;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        
        .btn-info {
            background: #17a2b8;
            color: white;
        }
        
        .btn-warning {
            background: #ffc107;
            color: #212529;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .data-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 12px;
            text-align: left;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .welcome-screen {
            text-align: center;
            padding: 60px 20px;
        }
        
        .welcome-screen h2 {
            color: #667eea;
            margin-bottom: 20px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        
        .stat-card {
            padding: 25px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 14px;
            color: #666;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <div class="app-title">üìä Abbas Sons Roll Tech - Ledger System</div>
        </header>
        
        <nav class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('home')">üè† Home</button>
            <button class="nav-tab" onclick="switchTab('data-entry')">üìù Data Entry</button>
            <button class="nav-tab" onclick="switchTab('customers')">üë• Customers</button>
            <button class="nav-tab" onclick="switchTab('balance-sheet')">üìä Balance Sheet</button>
            <button class="nav-tab" onclick="switchTab('backup')">üíæ Backup</button>
        </nav>
        
        <div class="content-area">
            <!-- Home Tab -->
            <div id="home-tab" class="tab-content active">
                <div class="welcome-screen">
                    <h2>Welcome to Your Ledger System</h2>
                    <p>Complete offline-capable ledger management</p>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalCustomers">0</div>
                            <div class="stat-label">Total Customers</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalTransactions">0</div>
                            <div class="stat-label">Transactions</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalDR">Rs. 0</div>
                            <div class="stat-label">Total DR</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalCR">Rs. 0</div>
                            <div class="stat-label">Total CR</div>
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" onclick="switchTab('customers')">‚ûï Add Your First Customer</button>
                </div>
            </div>
            
            <!-- Data Entry Tab -->
            <div id="data-entry-tab" class="tab-content">
                <h2 style="color: #667eea; margin-bottom: 20px;">üìù Transaction Data Entry</h2>
                <div id="entryAlert"></div>
                
                <form id="dataEntryForm" onsubmit="submitTransaction(event)">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <!-- Date -->
                        <div class="form-group">
                            <label for="entryDate">Date *</label>
                            <input type="date" id="entryDate" class="form-control" required>
                        </div>
                        
                        <!-- Customer -->
                        <div class="form-group">
                            <label for="entryCustomer">Customer Name *</label>
                            <select id="entryCustomer" class="form-control" required onchange="loadLastTransaction()">
                                <option value="">Select Customer</option>
                            </select>
                        </div>
                        
                        <!-- Description -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <label for="entryDescription">Description *</label>
                            <input type="text" id="entryDescription" class="form-control" placeholder="Enter transaction description" required>
                        </div>
                        
                        <!-- Item -->
                        <div class="form-group">
                            <label for="entryItem">Item</label>
                            <select id="entryItem" class="form-control" onchange="calculateAmount()">
                                <option value="">Select Item</option>
                                <option value="Chilled Gots">Chilled Gots</option>
                                <option value="Chilled Scrape">Chilled Scrape</option>
                                <option value="Guides">Guides</option>
                                <option value="Chilled Rolls">Chilled Rolls</option>
                                <option value="Fire Bricks">Fire Bricks</option>
                                <option value="H Oil">H Oil</option>
                                <option value="Magnese">Magnese</option>
                                <option value="Chrome">Chrome</option>
                                <option value="Black Scrape">Black Scrape</option>
                                <option value="White Scrape">White Scrape</option>
                                <option value="Toka Scrape">Toka Scrape</option>
                                <option value="Pig Scrape">Pig Scrape</option>
                            </select>
                        </div>
                        
                        <!-- Weight/Qty -->
                        <div class="form-group">
                            <label for="entryWeight">Weight (kg) / Qty</label>
                            <input type="number" id="entryWeight" class="form-control" placeholder="0.00" step="0.01" onchange="calculateAmount()">
                        </div>
                        
                        <!-- Rate -->
                        <div class="form-group">
                            <label for="entryRate">Rate (PKR)</label>
                            <input type="number" id="entryRate" class="form-control" placeholder="0.00" step="0.01" onchange="calculateAmount()">
                        </div>
                        
                        <!-- Transaction Type -->
                        <div class="form-group">
                            <label for="entryType">Transaction Type</label>
                            <select id="entryType" class="form-control" onchange="updateDrCrAuto()">
                                <option value="Sale">Sale</option>
                                <option value="Payment Received - Cash">Payment Received - Cash</option>
                                <option value="Payment Received - Bank">Payment Received - Bank</option>
                                <option value="Payment Given - Cash">Payment Given - Cash</option>
                                <option value="Payment Given - Bank">Payment Given - Bank</option>
                            </select>
                        </div>
                        
                        <!-- Payment Method -->
                        <div class="form-group">
                            <label for="entryPaymentMethod">Payment Method</label>
                            <select id="entryPaymentMethod" class="form-control">
                                <option value="">Select Method</option>
                                <option value="Cash">Cash</option>
                                <option value="Cheque">Cheque</option>
                                <option value="Bank Transfer">Bank Transfer</option>
                                <option value="Jazzcash">Jazzcash</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        
                        <!-- Bank Name -->
                        <div class="form-group">
                            <label for="entryBankName">Bank Name</label>
                            <select id="entryBankName" class="form-control">
                                <option value="">Select Bank</option>
                                <option value="HBL">HBL</option>
                                <option value="UBL">UBL</option>
                                <option value="MCB">MCB</option>
                                <option value="Allied Bank">Allied Bank</option>
                                <option value="Bank Alfalah">Bank Alfalah</option>
                                <option value="Askari Bank">Askari Bank</option>
                                <option value="Faisal Bank">Faisal Bank</option>
                                <option value="Meezan Bank">Meezan Bank</option>
                            </select>
                        </div>
                        
                        <!-- Cheque Number -->
                        <div class="form-group">
                            <label for="entryChequeNumber">Cheque Number</label>
                            <input type="text" id="entryChequeNumber" class="form-control" placeholder="Enter cheque number">
                        </div>
                        
                        <!-- Debit/Credit -->
                        <div class="form-group">
                            <label for="entryDrCr">Debit/Credit *</label>
                            <select id="entryDrCr" class="form-control" required>
                                <option value="Debit">Debit (Customer owes us)</option>
                                <option value="Credit">Credit (We owe customer)</option>
                            </select>
                        </div>
                        
                        <!-- Amount -->
                        <div class="form-group">
                            <label for="entryAmount">Amount (PKR) *</label>
                            <input type="number" id="entryAmount" class="form-control" placeholder="0.00" step="0.01" required style="font-size: 18px; font-weight: bold; background: #f0f7ff;">
                            <small style="color: #666; font-size: 12px;">üí° Auto-calculates from Weight √ó Rate</small>
                        </div>
                    </div>
                    
                    <!-- Last Transaction Preview -->
                    <div id="lastTransactionPreview" style="display: none; margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                        <h4 style="color: #1976d2; margin-bottom: 10px;">üìã Last Transaction for this Customer</h4>
                        <div id="lastTransactionContent" style="font-size: 14px; color: #333;"></div>
                        <button type="button" class="btn btn-primary" onclick="copyLastTransaction()" style="margin-top: 10px; padding: 8px 16px; font-size: 13px;">üìã Copy Last Transaction</button>
                    </div>
                    
                    <!-- Buttons -->
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button type="submit" class="btn btn-primary">üíæ Submit Transaction</button>
                        <button type="button" class="btn btn-success" onclick="submitAndNew()">üíæ Submit & Add New</button>
                        <button type="button" class="btn btn-danger" onclick="resetForm()">üîÑ Reset Form</button>
                    </div>
                </form>
            </div>
            
            <!-- Customers Tab -->
            <div id="customers-tab" class="tab-content">
                <h2 style="color: #667eea;">üë• Customer Management</h2>
                
                <button class="btn btn-primary" onclick="showAddCustomerModal()">‚ûï Add New Customer</button>
                
                <div id="customersList"></div>
            </div>
            
            <!-- Balance Sheet Tab -->
            <div id="balance-sheet-tab" class="tab-content">
                <h2 style="color: #667eea;">üìä Balance Sheet</h2>
                
                <button class="btn btn-primary" onclick="renderBalanceSheet()">üîÑ Refresh</button>
                
                <div id="balanceSheetContent"></div>
            </div>
            
            <!-- Backup Tab -->
            <div id="backup-tab" class="tab-content">
                <h2 style="color: #667eea;">üíæ Backup & Import</h2>
                
                <div style="margin: 20px 0;">
                    <h3>üì• Import Data</h3>
                    
                    <!-- File selection -->
                    <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 15px;">
                        <input type="file" id="importFile" accept=".json,.csv,.xlsx,.xls" style="display: none;">
                        <button type="button" class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                            üìÅ Choose File
                        </button>
                        <span id="fileName" style="color: #666; font-size: 14px;">No file chosen</span>
                    </div>
                    
                    <!-- Import Options -->
                    <div style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h4 style="margin-bottom: 10px;">‚öôÔ∏è Import Options</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="importMode" value="replace" checked> 
                                    Replace All Data
                                </label>
                                <small style="color: #666; display: block;">Clear existing data and import fresh</small>
                            </div>
                            
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="importMode" value="append"> 
                                    Append Data
                                </label>
                                <small style="color: #666; display: block;">Keep existing data and add new records</small>
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 10px;">
                            <label>
                                <input type="checkbox" id="autoCreateCustomers" checked> 
                                Auto-create missing customers
                            </label>
                        </div>
                    </div>
                    
                    <!-- Import buttons -->
                    <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-success" onclick="startImport()" id="importBtn" disabled style="padding: 12px 24px;">
                            üöÄ Start Bulk Import
                        </button>
                        <button class="btn btn-warning" onclick="quickImport()" id="quickImportBtn" disabled style="padding: 12px 24px;">
                            ‚ö° Quick Import
                        </button>
                    </div>
                    
                    <p style="color: #666; font-size: 14px;">Supported formats: JSON, CSV, Excel (.xlsx, .xls)</p>
                    
                    <!-- Import status -->
                    <div id="importStatus" style="margin-top: 15px;"></div>
                    
                    <!-- Progress bar -->
                    <div id="importProgress" style="display: none; margin-top: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span>Importing...</span>
                            <span id="progressText">0%</span>
                        </div>
                        <div style="width: 100%; height: 20px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                            <div id="progressBar" style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                </div>
                
                <div style="margin: 20px 0;">
                    <h3>üì§ Export Data</h3>
                    <button class="btn btn-primary" onclick="exportJSON()">üìÑ Download Full Backup (JSON)</button>
                    <button class="btn btn-success" onclick="exportCSV()">üìä Export to CSV</button>
                    <button class="btn btn-info" onclick="exportExcel()">üìó Export to Excel</button>
                </div>
                
                <!-- File Format Instructions -->
                <div style="margin: 20px 0; padding: 15px; background: #e3f2fd; border-radius: 8px; border-left: 4px solid #2196f3;">
                    <h4 style="color: #1976d2; margin-bottom: 15px;">üìã Supported File Formats:</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div style="padding: 15px; background: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px;">üìÑ</div>
                            <h5>JSON Backup</h5>
                            <p style="font-size: 12px; color: #666;">Full system backup with all data</p>
                        </div>
                        
                        <div style="padding: 15px; background: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px;">üìä</div>
                            <h5>CSV Files</h5>
                            <p style="font-size: 12px; color: #666;">Google Sheets, Excel exports</p>
                        </div>
                        
                        <div style="padding: 15px; background: white; border-radius: 8px; text-align: center;">
                            <div style="font-size: 24px;">üìó</div>
                            <h5>Excel Files</h5>
                            <p style="font-size: 12px; color: #666;">.xlsx, .xls worksheets</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 10px; background: #bbdefb; border-radius: 5px;">
                        <h5 style="color: #1565c0; margin-bottom: 10px;">üìä Recommended Columns for Excel/CSV:</h5>
                        <div style="font-family: monospace; font-size: 12px; background: white; padding: 10px; border-radius: 4px;">
                            Date, Customer, Description, Item, Weight, Rate, Debit, Credit, Type, Payment Method, Bank Name, Cheque Number
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Add Customer Modal -->
    <div id="addCustomerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚ûï Add New Customer</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            
            <form onsubmit="addCustomer(event)">
                <div class="form-group">
                    <label>Customer Name *</label>
                    <input type="text" id="newCustomerName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label>Opening Balance</label>
                    <input type="number" id="newCustomerBalance" class="form-control" step="0.01" value="0">
                </div>
                
                <div class="form-group">
                    <label>Balance Type</label>
                    <select id="newCustomerType" class="form-control">
                        <option value="DR">DR (Customer owes us)</option>
                        <option value="CR">CR (We owe customer)</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary">‚úÖ Add Customer</button>
                <button type="button" class="btn btn-danger" onclick="closeModal()">‚úï Cancel</button>
            </form>
        </div>
    </div>
    
    <script>
        // Global data storage
        let ledgerData = {
            customers: [],
            transactions: [],
            settings: {
                companyName: 'Abbas Sons Roll Tech',
                companyAddress: 'Lahore, Pakistan'
            }
        };
        
        // ========== CORE APPLICATION FUNCTIONS ==========
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ App loaded successfully');
            loadFromLocalStorage();
            updateDashboard();
            loadCustomerDropdown();
            document.getElementById('entryDate').valueAsDate = new Date();
            
            // File selection handler
            const importFile = document.getElementById('importFile');
            if (importFile) {
                importFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    const fileName = document.getElementById('fileName');
                    const importBtn = document.getElementById('importBtn');
                    const quickImportBtn = document.getElementById('quickImportBtn');
                    
                    if (file) {
                        fileName.textContent = file.name;
                        importBtn.disabled = false;
                        quickImportBtn.disabled = false;
                        fileName.style.color = '#28a745';
                        fileName.style.fontWeight = 'bold';
                    } else {
                        fileName.textContent = 'No file chosen';
                        importBtn.disabled = true;
                        quickImportBtn.disabled = true;
                        fileName.style.color = '#666';
                        fileName.style.fontWeight = 'normal';
                    }
                });
            }
        });
        
        // Tab switching
        function switchTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tabs
            const tabs = document.querySelectorAll('.tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // Remove active from nav tabs
            const navTabs = document.querySelectorAll('.nav-tab');
            navTabs.forEach(tab => tab.classList.remove('active'));
            
            // Show selected tab
            document.getElementById(tabName + '-tab').classList.add('active');
            
            // Set active nav tab
            event.target.classList.add('active');
            
            // Update content
            if (tabName === 'customers') {
                renderCustomersList();
            } else if (tabName === 'balance-sheet') {
                renderBalanceSheet();
            }
        }
        
        // Update dashboard
        function updateDashboard() {
            document.getElementById('totalCustomers').textContent = ledgerData.customers.length;
            document.getElementById('totalTransactions').textContent = ledgerData.transactions.length;
            
            let totalDR = 0, totalCR = 0;
            ledgerData.customers.forEach(customer => {
                const balance = calculateCustomerBalance(customer.name);
                if (balance.type === 'DR') totalDR += balance.amount;
                else if (balance.type === 'CR') totalCR += balance.amount;
            });
            
            document.getElementById('totalDR').textContent = 'Rs. ' + totalDR.toLocaleString();
            document.getElementById('totalCR').textContent = 'Rs. ' + totalCR.toLocaleString();
        }
        
        // Show/hide modal
        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('active');
        }
        
        function closeModal() {
            document.getElementById('addCustomerModal').classList.remove('active');
        }
        
        // Add customer
        function addCustomer(event) {
            event.preventDefault();
            
            const name = document.getElementById('newCustomerName').value.trim();
            const balance = parseFloat(document.getElementById('newCustomerBalance').value) || 0;
            const type = document.getElementById('newCustomerType').value;
            
            if (ledgerData.customers.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                alert('Customer already exists!');
                return;
            }
            
            ledgerData.customers.push({
                id: Date.now(),
                name: name,
                openingBalance: type === 'DR' ? balance : -balance,
                createdDate: new Date().toISOString()
            });
            
            if (balance !== 0) {
                ledgerData.transactions.push({
                    id: Date.now() + 1,
                    date: new Date().toISOString().split('T')[0],
                    customer: name,
                    description: 'Opening Balance',
                    amount: balance,
                    type: type,
                    debit: type === 'DR' ? balance : 0,
                    credit: type === 'CR' ? balance : 0
                });
            }
            
            saveToLocalStorage();
            closeModal();
            loadCustomerDropdown();
            renderCustomersList();
            updateDashboard();
            
            document.getElementById('newCustomerName').value = '';
            document.getElementById('newCustomerBalance').value = '0';
            
            alert('‚úÖ Customer added successfully!');
        }
        
        // Load customer dropdown
        function loadCustomerDropdown() {
            const select = document.getElementById('entryCustomer');
            select.innerHTML = '<option value="">Select Customer</option>';
            
            ledgerData.customers.sort((a, b) => a.name.localeCompare(b.name)).forEach(customer => {
                const option = document.createElement('option');
                option.value = customer.name;
                option.textContent = customer.name;
                select.appendChild(option);
            });
        }
        
        // Render customers list
        function renderCustomersList() {
            const container = document.getElementById('customersList');
            
            if (ledgerData.customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No customers yet. Click "Add New Customer" to start.</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Customer Name</th><th>Balance</th><th>DR/CR</th><th>Actions</th></tr></thead><tbody>';
            
            ledgerData.customers.forEach(customer => {
                const balance = calculateCustomerBalance(customer.name);
                const transCount = ledgerData.transactions.filter(t => t.customer === customer.name).length;
                
                html += `
                    <tr>
                        <td><strong>${customer.name}</strong></td>
                        <td>Rs. ${balance.amount.toLocaleString()}</td>
                        <td style="color: ${balance.type === 'DR' ? '#dc3545' : '#28a745'}; font-weight: bold;">${balance.type}</td>
                        <td>
                            <button class="btn btn-primary" onclick="viewLedger('${customer.name}')" style="padding: 6px 12px; font-size: 12px;">üìã View</button>
                            <button class="btn btn-danger" onclick="deleteCustomer('${customer.name}')" style="padding: 6px 12px; font-size: 12px;">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // Calculate customer balance
        function calculateCustomerBalance(customerName) {
            const transactions = ledgerData.transactions.filter(t => t.customer === customerName);
            let totalDebit = 0, totalCredit = 0;
            
            transactions.forEach(t => {
                totalDebit += t.debit || 0;
                totalCredit += t.credit || 0;
            });
            
            const balance = totalDebit - totalCredit;
            
            return {
                amount: Math.abs(balance),
                type: balance === 0 ? 'Nill' : (balance > 0 ? 'DR' : 'CR')
            };
        }
        
        // Render balance sheet
        function renderBalanceSheet() {
            const container = document.getElementById('balanceSheetContent');
            
            if (ledgerData.customers.length === 0) {
                container.innerHTML = '<p style="text-align: center; padding: 40px; color: #666;">No customers to display</p>';
                return;
            }
            
            let html = '<table class="data-table"><thead><tr><th>Customer</th><th>Balance</th><th>DR/CR</th></tr></thead><tbody>';
            
            ledgerData.customers.forEach(customer => {
                const balance = calculateCustomerBalance(customer.name);
                html += `
                    <tr>
                        <td><strong>${customer.name}</strong></td>
                        <td>Rs. ${balance.amount.toLocaleString()}</td>
                        <td style="color: ${balance.type === 'DR' ? '#dc3545' : '#28a745'}; font-weight: bold;">${balance.type}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }
        
        // View customer ledger
        function viewLedger(customerName) {
            const transactions = ledgerData.transactions.filter(t => t.customer === customerName);
            
            if (transactions.length === 0) {
                alert('No transactions for this customer');
                return;
            }
            
            let html = `<html><head><title>${customerName} Ledger</title></head><body style="font-family: Arial; padding: 20px;">`;
            html += `<h1 style="color: #667eea;">${customerName} - LEDGER</h1>`;
            html += '<table border="1" cellpadding="10" style="width: 100%; border-collapse: collapse;"><thead><tr><th>Date</th><th>Description</th><th>Debit</th><th>Credit</th></tr></thead><tbody>';
            
            transactions.forEach(t => {
                html += `<tr><td>${t.date}</td><td>${t.description}</td><td>${t.debit ? 'Rs. ' + t.debit.toLocaleString() : '-'}</td><td>${t.credit ? 'Rs. ' + t.credit.toLocaleString() : '-'}</td></tr>`;
            });
            
            const balance = calculateCustomerBalance(customerName);
            html += `<tr style="background: #f8f9fa; font-weight: bold;"><td colspan="3">BALANCE</td><td>Rs. ${balance.amount.toLocaleString()} ${balance.type}</td></tr>`;
            html += '</tbody></table></body></html>';
            
            const win = window.open('', '_blank');
            win.document.write(html);
            win.document.close();
        }
        
        // Delete customer
        function deleteCustomer(customerName) {
            if (!confirm(`Delete ${customerName} and all transactions?`)) return;
            
            ledgerData.customers = ledgerData.customers.filter(c => c.name !== customerName);
            ledgerData.transactions = ledgerData.transactions.filter(t => t.customer !== customerName);
            
            saveToLocalStorage();
            renderCustomersList();
            loadCustomerDropdown();
            updateDashboard();
            
            alert('‚úÖ Customer deleted');
        }
        
        // Export JSON
        function exportJSON() {
            const dataStr = JSON.stringify(ledgerData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ledger-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            alert('‚úÖ Backup downloaded!');
        }
        
        // Export CSV
        function exportCSV() {
            let csv = 'Customer,Date,Description,Item,Weight,Rate,Debit,Credit,Type,Payment Method,Bank Name,Cheque Number\n';
            
            ledgerData.transactions.forEach(t => {
                const row = [
                    `"${t.customer || ''}"`,
                    `"${t.date || ''}"`,
                    `"${t.description || ''}"`,
                    `"${t.item || ''}"`,
                    `"${t.weight || ''}"`,
                    `"${t.rate || ''}"`,
                    `"${t.debit || 0}"`,
                    `"${t.credit || 0}"`,
                    `"${t.type || ''}"`,
                    `"${t.paymentMethod || ''}"`,
                    `"${t.bankName || ''}"`,
                    `"${t.chequeNumber || ''}"`
                ];
                csv += row.join(',') + '\n';
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `ledger-export-${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            alert('‚úÖ CSV exported with all transaction details!');
        }
        
        // Smart Amount Calculation (like Google Sheets)
        function calculateAmount() {
            const item = document.getElementById('entryItem').value;
            const weight = parseFloat(document.getElementById('entryWeight').value) || 0;
            const rate = parseFloat(document.getElementById('entryRate').value) || 0;
            
            if (weight && rate) {
                let amount = 0;
                const scrapeItems = ['Black Scrape', 'White Scrape', 'Toka Scrape', 'Pig Scrape'];
                
                if (scrapeItems.includes(item)) {
                    // For scrape items: divide by 37.324
                    amount = (weight / 37.324) * rate;
                } else {
                    // For other items: simple multiplication
                    amount = weight * rate;
                }
                
                document.getElementById('entryAmount').value = amount.toFixed(2);
            }
        }

        // Auto DR/CR based on transaction type
        function updateDrCrAuto() {
            const type = document.getElementById('entryType').value;
            const drCrSelect = document.getElementById('entryDrCr');
            
            if (type.includes('Payment Received')) {
                drCrSelect.value = 'Credit'; // We received payment = Credit
            } else if (type.includes('Payment Given')) {
                drCrSelect.value = 'Debit'; // We gave payment = Debit
            } else if (type === 'Sale') {
                drCrSelect.value = 'Debit'; // Sale = Debit (customer owes us)
            }
        }

        // Load last transaction for selected customer
        function loadLastTransaction() {
            const customerName = document.getElementById('entryCustomer').value;
            if (!customerName) {
                document.getElementById('lastTransactionPreview').style.display = 'none';
                return;
            }
            
            const customerTransactions = ledgerData.transactions.filter(t => t.customer === customerName);
            
            if (customerTransactions.length === 0) {
                document.getElementById('lastTransactionPreview').style.display = 'none';
                return;
            }
            
            // Get the most recent transaction
            const lastTrans = customerTransactions[customerTransactions.length - 1];
            
            let html = `
                <div><strong>üìÖ Date:</strong> ${lastTrans.date}</div>
                <div><strong>üìù Description:</strong> ${lastTrans.description}</div>
                ${lastTrans.item ? '<div><strong>üì¶ Item:</strong> ' + lastTrans.item + '</div>' : ''}
                ${lastTrans.weight ? '<div><strong>‚öñÔ∏è Weight/Qty:</strong> ' + lastTrans.weight + '</div>' : ''}
                ${lastTrans.rate ? '<div><strong>üíµ Rate:</strong> Rs. ' + lastTrans.rate + '</div>' : ''}
                <div><strong>üí∞ Amount:</strong> Rs. ${lastTrans.amount.toLocaleString()}</div>
                <div><strong>üìä Type:</strong> ${lastTrans.type}</div>
            `;
            
            document.getElementById('lastTransactionContent').innerHTML = html;
            document.getElementById('lastTransactionPreview').style.display = 'block';
            
            // Store last transaction globally for copying
            window.lastTransaction = lastTrans;
        }

        // Copy last transaction to form
        function copyLastTransaction() {
            if (!window.lastTransaction) return;
            
            const last = window.lastTransaction;
            
            if (last.description) document.getElementById('entryDescription').value = last.description;
            if (last.item) document.getElementById('entryItem').value = last.item;
            if (last.weight) document.getElementById('entryWeight').value = last.weight;
            if (last.rate) document.getElementById('entryRate').value = last.rate;
            if (last.amount) document.getElementById('entryAmount').value = last.amount;
            if (last.paymentMethod) document.getElementById('entryPaymentMethod').value = last.paymentMethod;
            if (last.bankName) document.getElementById('entryBankName').value = last.bankName;
            if (last.type) document.getElementById('entryDrCr').value = last.type;
            
            alert('‚úÖ Last transaction copied! Modify as needed and submit.');
        }

        // Submit and add new
        function submitAndNew() {
            const form = document.getElementById('dataEntryForm');
            if (form.checkValidity()) {
                submitTransaction(new Event('submit'));
                setTimeout(() => {
                    const customer = document.getElementById('entryCustomer').value;
                    resetForm();
                    document.getElementById('entryCustomer').value = customer;
                    loadLastTransaction();
                }, 500);
            } else {
                form.reportValidity();
            }
        }

        // Enhanced submit transaction
        function submitTransaction(event) {
            event.preventDefault();
            
            const customer = document.getElementById('entryCustomer').value;
            const description = document.getElementById('entryDescription').value;
            const bankName = document.getElementById('entryBankName').value;
            const chequeNumber = document.getElementById('entryChequeNumber').value;
            const transactionType = document.getElementById('entryType').value;
            
            // Build final description
            let finalDescription = description;
            if (transactionType.includes('Payment') && bankName) {
                finalDescription += ' - ' + bankName;
            }
            if (chequeNumber) {
                finalDescription += ' - Chq: ' + chequeNumber;
            }
            
            const transaction = {
                id: Date.now(),
                date: document.getElementById('entryDate').value,
                customer: customer,
                description: finalDescription,
                item: document.getElementById('entryItem').value,
                weight: document.getElementById('entryWeight').value,
                rate: document.getElementById('entryRate').value,
                amount: parseFloat(document.getElementById('entryAmount').value),
                type: document.getElementById('entryDrCr').value,
                transactionType: transactionType,
                paymentMethod: document.getElementById('entryPaymentMethod').value,
                bankName: bankName,
                chequeNumber: chequeNumber,
                debit: document.getElementById('entryDrCr').value === 'Debit' ? parseFloat(document.getElementById('entryAmount').value) : 0,
                credit: document.getElementById('entryDrCr').value === 'Credit' ? parseFloat(document.getElementById('entryAmount').value) : 0
            };
            
            ledgerData.transactions.push(transaction);
            saveToLocalStorage();
            
            document.getElementById('entryAlert').innerHTML = '<div class="alert alert-success">‚úÖ Transaction saved successfully!</div>';
            setTimeout(() => { document.getElementById('entryAlert').innerHTML = ''; }, 3000);
            
            resetForm();
            updateDashboard();
        }

        // Enhanced reset form
        function resetForm() {
            document.getElementById('dataEntryForm').reset();
            document.getElementById('entryDate').valueAsDate = new Date();
            document.getElementById('entryType').value = 'Sale';
            document.getElementById('lastTransactionPreview').style.display = 'none';
            document.getElementById('entryAmount').value = '';
        }
        
        // Local storage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('ledgerData', JSON.stringify(ledgerData));
                console.log('‚úÖ Data saved');
            } catch (error) {
                console.error('‚ùå Save failed:', error);
            }
        }
        
        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('ledgerData');
                if (saved) {
                    ledgerData = JSON.parse(saved);
                    console.log('‚úÖ Data loaded');
                }
            } catch (error) {
                console.error('‚ùå Load failed:', error);
            }
        }

        // ========== IMPORT/EXPORT FUNCTIONS ==========
        
        // Update progress bar
        function updateProgress(percent, text) {
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            
            if (progressBar && progressText) {
                progressBar.style.width = percent + '%';
                progressText.textContent = text || percent + '%';
            }
        }

        // Reset import form
        function resetImportForm() {
            document.getElementById('importFile').value = '';
            document.getElementById('fileName').textContent = 'No file chosen';
            document.getElementById('importBtn').disabled = true;
            document.getElementById('quickImportBtn').disabled = true;
        }

        // Quick Import without progress bars
        function quickImport() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('importStatus');
            
            if (!file) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Please select a file first</div>';
                return;
            }
            
            statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ Quick importing file... Please wait</div>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    const fileName = file.name.toLowerCase();
                    
                    if (fileName.endsWith('.json')) {
                        quickImportJSONData(fileContent, statusDiv);
                    } else if (fileName.endsWith('.csv')) {
                        quickImportCSVData(fileContent, statusDiv);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        quickImportExcelData(fileContent, statusDiv);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Unsupported file format. Please use JSON, CSV, or Excel files.</div>';
                    }
                } catch (error) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error reading file: ' + error.message + '</div>';
                }
            };
            
            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error reading file</div>';
            };
            
            if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        // Enhanced Import Handler with Excel Support
        function startImport() {
            console.log('Start Import clicked');
            
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            const statusDiv = document.getElementById('importStatus');
            const progressDiv = document.getElementById('importProgress');
            
            if (!file) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Please select a file first</div>';
                return;
            }
            
            console.log('File selected:', file.name);
            
            // Show progress
            progressDiv.style.display = 'block';
            updateProgress(0, 'Starting import...');
            
            statusDiv.innerHTML = '<div class="alert alert-info">‚è≥ Reading file... Please wait</div>';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    updateProgress(30, 'Processing file...');
                    const fileContent = e.target.result;
                    const fileName = file.name.toLowerCase();
                    
                    console.log('File type detected:', fileName);
                    
                    if (fileName.endsWith('.json')) {
                        importJSONData(fileContent, statusDiv);
                    } else if (fileName.endsWith('.csv')) {
                        importCSVData(fileContent, statusDiv);
                    } else if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
                        importExcelData(fileContent, statusDiv);
                    } else {
                        statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Unsupported file format. Please use JSON, CSV, or Excel files.</div>';
                        progressDiv.style.display = 'none';
                    }
                } catch (error) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error reading file: ' + error.message + '</div>';
                    progressDiv.style.display = 'none';
                    console.error('File read error:', error);
                }
            };
            
            reader.onerror = function() {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error reading file</div>';
                progressDiv.style.display = 'none';
            };
            
            // Read based on file type
            if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
                reader.readAsArrayBuffer(file);
            } else {
                reader.readAsText(file);
            }
        }

        // Enhanced JSON Import
        function importJSONData(fileContent, statusDiv) {
            try {
                updateProgress(50, 'Processing JSON data...');
                const data = JSON.parse(fileContent);
                
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                
                if (confirm(`This will ${importMode === 'replace' ? 'REPLACE ALL' : 'ADD TO'} your data with JSON import. Continue?`)) {
                    if (importMode === 'replace') {
                        // Replace all data
                        ledgerData = data;
                    } else {
                        // Append data - merge customers and transactions
                        if (data.customers) {
                            data.customers.forEach(newCustomer => {
                                if (!ledgerData.customers.find(c => c.name === newCustomer.name)) {
                                    ledgerData.customers.push(newCustomer);
                                }
                            });
                        }
                        if (data.transactions) {
                            data.transactions.forEach(newTransaction => {
                                ledgerData.transactions.push({
                                    ...newTransaction,
                                    id: Date.now() + Math.random() // New ID to avoid conflicts
                                });
                            });
                        }
                    }
                    
                    updateProgress(80, 'Saving data...');
                    saveToLocalStorage();
                    updateDashboard();
                    loadCustomerDropdown();
                    
                    updateProgress(100, 'Complete!');
                    
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ JSON data imported successfully!<br>' +
                                         `Mode: ${importMode === 'replace' ? 'Replace All' : 'Append'}<br>` +
                                         'Customers: ' + ledgerData.customers.length + '<br>' +
                                         'Transactions: ' + ledgerData.transactions.length + '</div>';
                    
                    resetImportForm();
                    
                    setTimeout(() => {
                        document.getElementById('importProgress').style.display = 'none';
                    }, 2000);
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Import cancelled</div>';
                    document.getElementById('importProgress').style.display = 'none';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Invalid JSON file: ' + error.message + '</div>';
                document.getElementById('importProgress').style.display = 'none';
            }
        }

        // Quick JSON Import
        function quickImportJSONData(fileContent, statusDiv) {
            try {
                const data = JSON.parse(fileContent);
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                
                if (confirm(`This will ${importMode === 'replace' ? 'REPLACE ALL' : 'ADD TO'} your data. Continue?`)) {
                    if (importMode === 'replace') {
                        ledgerData = data;
                    } else {
                        if (data.customers) {
                            data.customers.forEach(newCustomer => {
                                if (!ledgerData.customers.find(c => c.name === newCustomer.name)) {
                                    ledgerData.customers.push(newCustomer);
                                }
                            });
                        }
                        if (data.transactions) {
                            data.transactions.forEach(newTransaction => {
                                ledgerData.transactions.push({
                                    ...newTransaction,
                                    id: Date.now() + Math.random()
                                });
                            });
                        }
                    }
                    
                    saveToLocalStorage();
                    updateDashboard();
                    loadCustomerDropdown();
                    
                    statusDiv.innerHTML = '<div class="alert alert-success">‚úÖ JSON data imported successfully!<br>' +
                                         `Mode: ${importMode === 'replace' ? 'Replace All' : 'Append'}<br>` +
                                         'Customers: ' + ledgerData.customers.length + '<br>' +
                                         'Transactions: ' + ledgerData.transactions.length + '</div>';
                    
                    resetImportForm();
                } else {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Import cancelled</div>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Invalid JSON file: ' + error.message + '</div>';
            }
        }

        // Enhanced CSV Import
        function importCSVData(csvContent, statusDiv) {
            try {
                updateProgress(40, 'Processing CSV data...');
                
                const lines = csvContent.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå CSV file is empty or has no data rows</div>';
                    document.getElementById('importProgress').style.display = 'none';
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                const autoCreateCustomers = document.getElementById('autoCreateCustomers').checked;
                
                console.log('CSV Headers:', headers);
                
                // Show detected columns for debugging
                statusDiv.innerHTML += `<div class="alert alert-info">üìä Detected columns: ${headers.join(', ')}</div>`;
                
                if (!confirm(`This will ${importMode === 'replace' ? 'REPLACE ALL' : 'ADD TO'} your data with CSV import. Continue?`)) {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Import cancelled</div>';
                    document.getElementById('importProgress').style.display = 'none';
                    return;
                }
                
                // Clear data if replace mode
                if (importMode === 'replace') {
                    ledgerData.customers = [];
                    ledgerData.transactions = [];
                }
                
                let importedTransactions = 0;
                let importedCustomers = new Set();
                let skippedRows = 0;
                
                updateProgress(60, 'Processing rows...');
                
                // Process CSV rows
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = parseCSVLine(line);
                    if (values.length < headers.length) {
                        skippedRows++;
                        continue;
                    }
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                    });
                    
                    // Use enhanced detection for CSV too
                    const customerName = enhancedFindCustomerName(row, headers);
                    const date = enhancedFindDate(row, headers);
                    
                    if (!customerName || !date) {
                        skippedRows++;
                        continue;
                    }
                    
                    // Track customer
                    importedCustomers.add(customerName);
                    
                    // Create transaction with enhanced function
                    const transaction = enhancedCreateTransaction(row, headers, customerName, date, i);
                    if (transaction) {
                        ledgerData.transactions.push(transaction);
                        importedTransactions++;
                        
                        // Create customer if doesn't exist and auto-create is enabled
                        if (autoCreateCustomers && !ledgerData.customers.find(c => c.name === customerName)) {
                            ledgerData.customers.push({
                                id: Date.now() + i + 10000,
                                name: customerName,
                                openingBalance: 0,
                                createdDate: new Date().toISOString()
                            });
                        }
                    } else {
                        skippedRows++;
                    }
                    
                    // Update progress
                    if (i % 10 === 0) {
                        const progress = 60 + Math.floor((i / lines.length) * 30);
                        updateProgress(progress, `Processing row ${i} of ${lines.length}...`);
                    }
                }
                
                updateProgress(95, 'Saving data...');
                
                saveToLocalStorage();
                updateDashboard();
                loadCustomerDropdown();
                
                updateProgress(100, 'Complete!');
                
                statusDiv.innerHTML = '<div class="alert alert-success">' +
                    '‚úÖ CSV Import Successful!<br>' +
                    `Mode: ${importMode === 'replace' ? 'Replace All' : 'Append'}<br>` +
                    'üìä Transactions imported: ' + importedTransactions + '<br>' +
                    'üë• Customers processed: ' + importedCustomers.size + '<br>' +
                    (skippedRows > 0 ? '‚è≠Ô∏è Rows skipped: ' + skippedRows + '<br>' : '') +
                    'üíæ All data is now available offline' +
                    '</div>';
                
                resetImportForm();
                
                setTimeout(() => {
                    document.getElementById('importProgress').style.display = 'none';
                }, 2000);
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error importing CSV: ' + error.message + '</div>';
                document.getElementById('importProgress').style.display = 'none';
                console.error('CSV import error:', error);
            }
        }

        // Quick CSV Import
        function quickImportCSVData(csvContent, statusDiv) {
            try {
                const lines = csvContent.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå CSV file is empty or has no data rows</div>';
                    return;
                }
                
                const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                const autoCreateCustomers = document.getElementById('autoCreateCustomers').checked;
                
                if (!confirm(`This will ${importMode === 'replace' ? 'REPLACE ALL' : 'ADD TO'} your data. Continue?`)) {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Import cancelled</div>';
                    return;
                }
                
                if (importMode === 'replace') {
                    ledgerData.customers = [];
                    ledgerData.transactions = [];
                }
                
                let importedTransactions = 0;
                let importedCustomers = new Set();
                let skippedRows = 0;
                
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (!line) continue;
                    
                    const values = parseCSVLine(line);
                    if (values.length < headers.length) {
                        skippedRows++;
                        continue;
                    }
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].replace(/"/g, '').trim() : '';
                    });
                    
                    const customerName = enhancedFindCustomerName(row, headers);
                    const date = enhancedFindDate(row, headers);
                    
                    if (!customerName || !date) {
                        skippedRows++;
                        continue;
                    }
                    
                    importedCustomers.add(customerName);
                    
                    const transaction = enhancedCreateTransaction(row, headers, customerName, date, i);
                    if (transaction) {
                        ledgerData.transactions.push(transaction);
                        importedTransactions++;
                        
                        if (autoCreateCustomers && !ledgerData.customers.find(c => c.name === customerName)) {
                            ledgerData.customers.push({
                                id: Date.now() + i + 10000,
                                name: customerName,
                                openingBalance: 0,
                                createdDate: new Date().toISOString()
                            });
                        }
                    } else {
                        skippedRows++;
                    }
                }
                
                saveToLocalStorage();
                updateDashboard();
                loadCustomerDropdown();
                
                statusDiv.innerHTML = '<div class="alert alert-success">' +
                    '‚úÖ CSV Import Successful!<br>' +
                    `Mode: ${importMode === 'replace' ? 'Replace All' : 'Append'}<br>` +
                    'üìä Transactions imported: ' + importedTransactions + '<br>' +
                    'üë• Customers processed: ' + importedCustomers.size + '<br>' +
                    (skippedRows > 0 ? '‚è≠Ô∏è Rows skipped: ' + skippedRows + '<br>' : '') +
                    'üíæ All data is now available offline' +
                    '</div>';
                
                resetImportForm();
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error importing CSV: ' + error.message + '</div>';
                console.error('CSV import error:', error);
            }
        }

        // Enhanced Excel Import Function with Better Column Detection
        function importExcelData(arrayBuffer, statusDiv) {
            try {
                updateProgress(40, 'Reading Excel workbook...');
                
                // Read Excel file
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                // Convert to JSON with headers
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Excel file is empty or has no data rows</div>';
                    document.getElementById('importProgress').style.display = 'none';
                    return;
                }
                
                updateProgress(60, 'Processing Excel data...');
                
                const headers = jsonData[0].map(h => String(h).trim());
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                const autoCreateCustomers = document.getElementById('autoCreateCustomers').checked;
                
                console.log('Excel columns detected:', headers);
                
                // Show detected columns for debugging
                statusDiv.innerHTML += `<div class="alert alert-info">üìä Detected columns: ${headers.join(', ')}</div>`;
                
                if (!confirm(`This will ${importMode === 'replace' ? 'REPLACE ALL' : 'ADD TO'} your data with Excel import. Continue?`)) {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Import cancelled</div>';
                    document.getElementById('importProgress').style.display = 'none';
                    return;
                }
                
                // Clear data if replace mode
                if (importMode === 'replace') {
                    ledgerData.customers = [];
                    ledgerData.transactions = [];
                }
                
                let importedTransactions = 0;
                let importedCustomers = new Set();
                let skippedRows = 0;
                let debugInfo = [];
                
                // Process Excel rows
                for (let i = 1; i < jsonData.length; i++) {
                    const rowData = jsonData[i];
                    if (!rowData || rowData.length === 0) continue;
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = rowData[index] !== undefined ? String(rowData[index]).trim() : '';
                    });
                    
                    // Debug: Log first few rows to see what's being read
                    if (i <= 3) {
                        debugInfo.push(`Row ${i}: ${JSON.stringify(row)}`);
                    }
                    
                    // Enhanced customer name detection
                    const customerName = enhancedFindCustomerName(row, headers);
                    const date = enhancedFindDate(row, headers);
                    
                    if (!customerName) {
                        debugInfo.push(`Row ${i} skipped: No customer name found`);
                        skippedRows++;
                        continue;
                    }
                    
                    if (!date) {
                        debugInfo.push(`Row ${i} skipped: No valid date found`);
                        skippedRows++;
                        continue;
                    }
                    
                    // Track customer
                    importedCustomers.add(customerName);
                    
                    // Create transaction with enhanced data extraction
                    const transaction = enhancedCreateTransaction(row, headers, customerName, date, i);
                    if (transaction) {
                        ledgerData.transactions.push(transaction);
                        importedTransactions++;
                        
                        // Create customer if doesn't exist and auto-create is enabled
                        if (autoCreateCustomers && !ledgerData.customers.find(c => c.name === customerName)) {
                            ledgerData.customers.push({
                                id: Date.now() + i + 10000,
                                name: customerName,
                                openingBalance: 0,
                                createdDate: new Date().toISOString()
                            });
                        }
                    } else {
                        debugInfo.push(`Row ${i} skipped: Could not create transaction`);
                        skippedRows++;
                    }
                    
                    // Update progress
                    if (i % 10 === 0) {
                        const progress = 60 + Math.floor((i / jsonData.length) * 30);
                        updateProgress(progress, `Processing row ${i} of ${jsonData.length}...`);
                    }
                }
                
                updateProgress(95, 'Saving data...');
                
                saveToLocalStorage();
                updateDashboard();
                loadCustomerDropdown();
                
                updateProgress(100, 'Complete!');
                
                // Show debug info for first few rows
                if (debugInfo.length > 0) {
                    console.log('Debug Info:', debugInfo);
                    statusDiv.innerHTML += `<div class="alert alert-info">
                        <strong>Debug Info (first 3 rows):</strong><br>
                        ${debugInfo.slice(0, 3).join('<br>')}
                    </div>`;
                }
                
                statusDiv.innerHTML = '<div class="alert alert-success">' +
                    '‚úÖ Excel Import Completed!<br>' +
                    'üìä Transactions imported: ' + importedTransactions + '<br>' +
                    'üë• Customers processed: ' + importedCustomers.size + '<br>' +
                    (skippedRows > 0 ? '‚è≠Ô∏è Rows skipped: ' + skippedRows + '<br>' : '') +
                    'üíæ Data saved successfully' +
                    '</div>';
                
                resetImportForm();
                
                setTimeout(() => {
                    document.getElementById('importProgress').style.display = 'none';
                }, 3000);
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error importing Excel file: ' + error.message + '</div>';
                document.getElementById('importProgress').style.display = 'none';
                console.error('Excel import error:', error);
            }
        }

        // Quick Excel Import
        function quickImportExcelData(arrayBuffer, statusDiv) {
            try {
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                
                const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                if (jsonData.length < 2) {
                    statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Excel file is empty or has no data rows</div>';
                    return;
                }
                
                const headers = jsonData[0].map(h => String(h).trim());
                const importMode = document.querySelector('input[name="importMode"]:checked').value;
                const autoCreateCustomers = document.getElementById('autoCreateCustomers').checked;
                
                if (!confirm(`This will ${importMode === 'replace' ? 'REPLACE ALL' : 'ADD TO'} your data. Continue?`)) {
                    statusDiv.innerHTML = '<div class="alert alert-info">‚ÑπÔ∏è Import cancelled</div>';
                    return;
                }
                
                if (importMode === 'replace') {
                    ledgerData.customers = [];
                    ledgerData.transactions = [];
                }
                
                let importedTransactions = 0;
                let importedCustomers = new Set();
                let skippedRows = 0;
                
                for (let i = 1; i < jsonData.length; i++) {
                    const rowData = jsonData[i];
                    if (!rowData || rowData.length === 0) continue;
                    
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = rowData[index] !== undefined ? String(rowData[index]).trim() : '';
                    });
                    
                    const customerName = enhancedFindCustomerName(row, headers);
                    const date = enhancedFindDate(row, headers);
                    
                    if (!customerName || !date) {
                        skippedRows++;
                        continue;
                    }
                    
                    importedCustomers.add(customerName);
                    
                    const transaction = enhancedCreateTransaction(row, headers, customerName, date, i);
                    if (transaction) {
                        ledgerData.transactions.push(transaction);
                        importedTransactions++;
                        
                        if (autoCreateCustomers && !ledgerData.customers.find(c => c.name === customerName)) {
                            ledgerData.customers.push({
                                id: Date.now() + i + 10000,
                                name: customerName,
                                openingBalance: 0,
                                createdDate: new Date().toISOString()
                            });
                        }
                    } else {
                        skippedRows++;
                    }
                }
                
                saveToLocalStorage();
                updateDashboard();
                loadCustomerDropdown();
                
                statusDiv.innerHTML = '<div class="alert alert-success">' +
                    '‚úÖ Excel Import Successful!<br>' +
                    'üìä Transactions imported: ' + importedTransactions + '<br>' +
                    'üë• Customers processed: ' + importedCustomers.size + '<br>' +
                    (skippedRows > 0 ? '‚è≠Ô∏è Rows skipped: ' + skippedRows + '<br>' : '') +
                    'üíæ All data is now available offline' +
                    '</div>';
                
                resetImportForm();
                
            } catch (error) {
                statusDiv.innerHTML = '<div class="alert alert-danger">‚ùå Error importing Excel file: ' + error.message + '</div>';
                console.error('Excel import error:', error);
            }
        }

        // ========== HELPER FUNCTIONS ==========

        // Helper function to parse CSV lines (handles commas in quotes)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            
            result.push(current);
            return result;
        }

        // Enhanced customer name detection
        function enhancedFindCustomerName(row, headers) {
            // Try exact column names first
            const exactMatches = ['Customer', 'CUSTOMER', 'customer', 'Party', 'PARTY', 'party', 'Name', 'NAME', 'name'];
            for (const key of exactMatches) {
                if (row[key] && row[key].trim()) {
                    return row[key].trim();
                }
            }
            
            // Try partial matches in column names
            for (const header of headers) {
                const lowerHeader = header.toLowerCase();
                if ((lowerHeader.includes('customer') || lowerHeader.includes('party') || lowerHeader.includes('name')) && 
                    row[header] && row[header].trim()) {
                    return row[header].trim();
                }
            }
            
            // Try to find any column that might contain a name (first non-empty string that's not a date/number)
            for (const header of headers) {
                const value = row[header];
                if (value && typeof value === 'string' && value.trim() && 
                    !isDateValue(value) && !isNumeric(value) && value.length > 1) {
                    return value.trim();
                }
            }
            
            return null;
        }

        // Enhanced date detection
        function enhancedFindDate(row, headers) {
            // Try exact column names first
            const exactMatches = ['Date', 'DATE', 'date', 'Transaction Date', 'TRANSACTION DATE'];
            for (const key of exactMatches) {
                if (row[key]) {
                    const date = parseDateValue(row[key]);
                    if (date) return date;
                }
            }
            
            // Try partial matches in column names
            for (const header of headers) {
                const lowerHeader = header.toLowerCase();
                if (lowerHeader.includes('date') && row[header]) {
                    const date = parseDateValue(row[header]);
                    if (date) return date;
                }
            }
            
            // Default to today's date if no date found
            return new Date().toISOString().split('T')[0];
        }

        // Enhanced transaction creation
        function enhancedCreateTransaction(row, headers, customerName, date, index) {
            let debit = 0;
            let credit = 0;
            let amount = 0;
            let description = '';
            let item = '';
            let weight = '';
            let rate = '';
            
            // Find debit/credit/amount values
            for (const header of headers) {
                const value = row[header];
                const lowerHeader = header.toLowerCase();
                
                if (isNumeric(value)) {
                    const numValue = parseFloat(value);
                    
                    if (lowerHeader.includes('debit') || lowerHeader.includes('dr')) {
                        debit = numValue;
                    } else if (lowerHeader.includes('credit') || lowerHeader.includes('cr')) {
                        credit = numValue;
                    } else if (lowerHeader.includes('amount') || lowerHeader.includes('amt')) {
                        amount = numValue;
                    }
                }
                
                // Find description
                if (!description && typeof value === 'string' && value.trim() && 
                    !lowerHeader.includes('date') && !lowerHeader.includes('customer') && 
                    !isNumeric(value)) {
                    description = value.trim();
                }
                
                // Find item
                if (!item && (lowerHeader.includes('item') || lowerHeader.includes('product'))) {
                    item = value || '';
                }
                
                // Find weight
                if (!weight && lowerHeader.includes('weight')) {
                    weight = value || '';
                }
                
                // Find rate
                if (!rate && lowerHeader.includes('rate')) {
                    rate = value || '';
                }
            }
            
            // If no debit/credit found but amount found, determine type
            if (debit === 0 && credit === 0 && amount > 0) {
                // Try to determine from description or use default
                const desc = description.toLowerCase();
                if (desc.includes('payment received') || desc.includes('credit') || desc.includes('cr')) {
                    credit = amount;
                } else {
                    debit = amount; // Default to debit
                }
            } else if (debit === 0 && credit === 0) {
                // Skip transactions with zero amount
                return null;
            }
            
            // Use amount from whichever is larger
            amount = Math.max(debit, credit);
            
            // Default description if none found
            if (!description) {
                description = `Transaction ${new Date().toLocaleDateString()}`;
            }
            
            return {
                id: Date.now() + index,
                date: date,
                customer: customerName,
                description: description,
                item: item,
                weight: weight,
                rate: rate,
                amount: amount,
                type: debit > 0 ? 'Debit' : 'Credit',
                transactionType: 'Sale', // Default
                paymentMethod: '',
                bankName: '',
                chequeNumber: '',
                debit: debit,
                credit: credit
            };
        }

        // Helper function to check if value is numeric
        function isNumeric(value) {
            if (value === null || value === undefined || value === '') return false;
            return !isNaN(value) && !isNaN(parseFloat(value));
        }

        // Helper function to check if value is a date
        function isDateValue(value) {
            if (!value) return false;
            const date = new Date(value);
            return !isNaN(date.getTime());
        }

        // Helper function to parse date value
        function parseDateValue(value) {
            if (!value) return null;
            
            // Handle Excel serial numbers
            if (typeof value === 'number') {
                return excelSerialToDate(value);
            }
            
            // Handle string dates
            const date = new Date(value);
            if (!isNaN(date.getTime())) {
                return date.toISOString().split('T')[0];
            }
            
            return null;
        }

        // Convert Excel serial date to JS date
        function excelSerialToDate(serial) {
            const utc_days = Math.floor(serial - 25569);
            const utc_value = utc_days * 86400;
            const date_info = new Date(utc_value * 1000);
            return date_info.toISOString().split('T')[0];
        }

        // Export to Excel function
        function exportExcel() {
            try {
                // Convert transactions to worksheet data
                const worksheetData = [
                    ['Date', 'Customer', 'Description', 'Item', 'Weight', 'Rate', 'Debit', 'Credit', 'Type', 'Payment Method', 'Bank Name', 'Cheque Number']
                ];
                
                ledgerData.transactions.forEach(t => {
                    worksheetData.push([
                        t.date,
                        t.customer,
                        t.description,
                        t.item || '',
                        t.weight || '',
                        t.rate || '',
                        t.debit || 0,
                        t.credit || 0,
                        t.type,
                        t.paymentMethod || '',
                        t.bankName || '',
                        t.chequeNumber || ''
                    ]);
                });
                
                // Create workbook
                const workbook = XLSX.utils.book_new();
                const worksheet = XLSX.utils.aoa_to_sheet(worksheetData);
                
                // Add worksheet to workbook
                XLSX.utils.book_append_sheet(workbook, worksheet, 'Ledger Data');
                
                // Generate Excel file
                XLSX.writeFile(workbook, `ledger-export-${new Date().toISOString().split('T')[0]}.xlsx`);
                
                alert('‚úÖ Excel file exported successfully!');
                
            } catch (error) {
                alert('‚ùå Error exporting Excel file: ' + error.message);
            }
        }

        console.log('‚úÖ Ledger System Ready!');
    </script>
</body>
</html>